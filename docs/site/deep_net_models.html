<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />


  <title>redxregressors.deep_net_models API documentation</title>
  <meta name="description" content="Module of deep learning regressor DNNs" />


  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>

  <style type="text/css">
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}
</style>
  <style type="text/css">
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  }

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; }

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;

      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/
</style>
  <style type="text/css">
  pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #ffffcc }
.codehilite { background: #f8f8f8; }
.codehilite .c { color: #3D7B7B; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #F00 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666 } /* Operator */
.codehilite .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #9C6500 } /* Comment.Preproc */
.codehilite .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.codehilite .gr { color: #E40000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #008400 } /* Generic.Inserted */
.codehilite .go { color: #717171 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #04D } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #687822 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #00F; font-weight: bold } /* Name.Class */
.codehilite .no { color: #800 } /* Name.Constant */
.codehilite .nd { color: #A2F } /* Name.Decorator */
.codehilite .ni { color: #717171; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #00F } /* Name.Function */
.codehilite .nl { color: #767600 } /* Name.Label */
.codehilite .nn { color: #00F; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #A2F; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #BBB } /* Text.Whitespace */
.codehilite .mb { color: #666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666 } /* Literal.Number.Float */
.codehilite .mh { color: #666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #A45A77 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #00F } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666 } /* Literal.Number.Integer.Long */
  </style>
  <style type="text/css">
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}
</style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>
<div id="container">




















  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">
    <li class="set"><h3>Super-module</h3>
      <ul>
        <li class="mono"><a href="index.html">redxregressors</a></li>
      </ul>
    </li>
    <li class="set"><h3><a href="#header-variables">Module variables</a></h3>

  <ul>
    <li class="mono"><a href="#redxregressors.deep_net_models.log">log</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>

  <ul>
    <li class="mono"><a href="#redxregressors.deep_net_models.build_in_memory_loader">build_in_memory_loader</a></li>
    <li class="mono"><a href="#redxregressors.deep_net_models.build_in_memory_loader_using_dataframe">build_in_memory_loader_using_dataframe</a></li>
    <li class="mono"><a href="#redxregressors.deep_net_models.evaluate_mtr_pytorch_model">evaluate_mtr_pytorch_model</a></li>
    <li class="mono"><a href="#redxregressors.deep_net_models.fit_mtr_pytorch_model">fit_mtr_pytorch_model</a></li>
    <li class="mono"><a href="#redxregressors.deep_net_models.fit_mtr_pytorch_model_per_task">fit_mtr_pytorch_model_per_task</a></li>
    <li class="mono"><a href="#redxregressors.deep_net_models.train_multitask_regressor">train_multitask_regressor</a></li>
    <li class="mono"><a href="#redxregressors.deep_net_models.train_progressive_multitask_regressor">train_progressive_multitask_regressor</a></li>
  </ul>

    </li>


    </ul>
  </div>

<article id="content">





  <header id="section-intro">
  <h1 class="title"><span class="name">redxregressors.deep_net_models</span> module</h1>
  <p>Module of deep learning regressor DNNs</p>

  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-redxregressors.deep_net_models', this);">Show source &equiv;</a></p>
  <div id="source-redxregressors.deep_net_models" class="source">
    <div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module of deep learning regressor DNNs</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">deepchem</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArrayLike</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_absolute_percentage_error</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">redxregressors</span><span class="w"> </span><span class="kn">import</span> <span class="n">utilities</span><span class="p">,</span> <span class="n">evaluate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">redxregressors.utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">seed_all</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_in_memory_loader_using_dataframe</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">task_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">featurizer</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">Featurizer</span><span class="p">,</span>
    <span class="n">ids_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">smiles_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">splitter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">Splitter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">frac_train</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">frac_valid</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">frac_test</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to build the in memory loader for the deepchem multitask regressor model.</span>
<span class="sd">    Args:</span>
<span class="sd">        tasks (List[str]): the names of the tasks to train on</span>
<span class="sd">        featurizer (dc.feat.Featurizer): the featurizer to use</span>
<span class="sd">        ids_column (Optional[str]): the name of the column containing the IDs</span>
<span class="sd">        smiles (List[str]): the SMILES strings</span>
<span class="sd">        targets (np.ndarray): the target values</span>
<span class="sd">        weights (np.ndarray): the weights for each task</span>
<span class="sd">        splitter (Optional[dc.splits.Splitter]): the splitter to use</span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: the training, validation and testing datasets and the splitter object if a splitter was provided otherwise the dataset and None, None, None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">torch</span><span class="o">.</span><span class="n">use_deterministic_algorithms</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="n">task_columns</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">task_columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>

    <span class="n">smiles</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">smiles_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">ids_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Create the loader object to load the data into the model from memory</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">InMemoryLoader</span><span class="p">(</span>
        <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span>
        <span class="n">featurizer</span><span class="o">=</span><span class="n">featurizer</span><span class="p">,</span>
        <span class="n">id_field</span><span class="o">=</span><span class="n">ids_column</span><span class="p">,</span>
        <span class="n">log_every_n</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Create the dataset object</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">ids</span><span class="p">),</span> <span class="n">shard_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">splitter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Split the dataset into training, validation and testing sets</span>
        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">splitter</span><span class="o">.</span><span class="n">train_valid_test_split</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="n">frac_train</span><span class="o">=</span><span class="n">frac_train</span><span class="p">,</span>
            <span class="n">frac_valid</span><span class="o">=</span><span class="n">frac_valid</span><span class="p">,</span>
            <span class="n">frac_test</span><span class="o">=</span><span class="n">frac_test</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span>
            <span class="n">log_every_n</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">splitter</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_in_memory_loader</span><span class="p">(</span>
    <span class="n">tasks</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">featurizer</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">Featurizer</span><span class="p">,</span>
    <span class="n">ids_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ids</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">smiles</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">targets</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">splitter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">Splitter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">frac_train</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">frac_valid</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">frac_test</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to build the in memory loader for the deepchem multitask regressor model.</span>
<span class="sd">    Args:</span>
<span class="sd">        tasks (List[str]): the names of the tasks to train on</span>
<span class="sd">        featurizer (dc.feat.Featurizer): the featurizer to use</span>
<span class="sd">        ids_column (Optional[str]): the name of the column containing the IDs</span>
<span class="sd">        smiles (List[str]): the SMILES strings</span>
<span class="sd">        targets (np.ndarray): the target values</span>
<span class="sd">        weights (np.ndarray): the weights for each task</span>
<span class="sd">        splitter (Optional[dc.splits.Splitter]): the splitter to use</span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: the training, validation and testing datasets and the splitter object if a splitter was provided otherwise the dataset and None, None, None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">torch</span><span class="o">.</span><span class="n">use_deterministic_algorithms</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create the loader object to load the data into the model from memory</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">InMemoryLoader</span><span class="p">(</span>
        <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span>
        <span class="n">featurizer</span><span class="o">=</span><span class="n">featurizer</span><span class="p">,</span>
        <span class="n">id_field</span><span class="o">=</span><span class="n">ids_column</span><span class="p">,</span>
        <span class="n">log_every_n</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Create the dataset object</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">ids</span><span class="p">),</span> <span class="n">shard_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">splitter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Split the dataset into training, validation and testing sets</span>
        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">splitter</span><span class="o">.</span><span class="n">train_valid_test_split</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="n">frac_train</span><span class="o">=</span><span class="n">frac_train</span><span class="p">,</span>
            <span class="n">frac_valid</span><span class="o">=</span><span class="n">frac_valid</span><span class="p">,</span>
            <span class="n">frac_test</span><span class="o">=</span><span class="n">frac_test</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span>
            <span class="n">log_every_n</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">splitter</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">fit_mtr_pytorch_model</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">torch_models</span><span class="o">.</span><span class="n">torch_model</span><span class="o">.</span><span class="n">TorchModel</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
    <span class="n">valid_dataset</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">unique_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">torch_models</span><span class="o">.</span><span class="n">torch_model</span><span class="o">.</span><span class="n">TorchModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to fit a multitask regressor pytorch model using the deepchem library.</span>
<span class="sd">    Args:</span>
<span class="sd">        model (dc.models.torch_models.torch_model.TorchModel): the model to train</span>
<span class="sd">        train_dataset (dc.data.data_loader.DataLoader): the training dataset</span>
<span class="sd">        valid_dataset (dc.data.data_loader.DataLoader): the validation dataset</span>
<span class="sd">        epochs (int): the number of epochs to train for</span>
<span class="sd">        unique_string (Optional[str]): a unique string to append to the output files</span>
<span class="sd">    Returns:</span>
<span class="sd">        dc.models.torch_models.torch_model.TorchModel: the trained model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">torch</span><span class="o">.</span><span class="n">use_deterministic_algorithms</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># train the model using an explicit loop to allow for intermediate evaluation</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">))</span>
    <span class="n">train_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">valid_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">plot_epoch_numbers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean-mean_squared_error&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>
    <span class="n">vs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean-mean_squared_error&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Processing epoch </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: latest train MSE (L2-loss) mean over tasks </span><span class="si">{</span><span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean-mean_squared_error&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> lastest validation MSE (L2-loss) mean over tasks </span><span class="si">{</span><span class="n">vs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean-mean_squared_error&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">nb_epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">epochs</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
                <span class="n">train_dataset</span><span class="p">,</span>
                <span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)],</span>
            <span class="p">)</span>
            <span class="n">train_scores</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">items</span><span class="p">()][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
                <span class="n">valid_dataset</span><span class="p">,</span>
                <span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)],</span>
            <span class="p">)</span>
            <span class="n">valid_scores</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="o">.</span><span class="n">items</span><span class="p">()][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">plot_epoch_numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train scores epoch </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">train_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation scores epoch </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">valid_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">evaluate</span><span class="o">.</span><span class="n">plot_metric_curves</span><span class="p">(</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">train_scores</span><span class="p">,</span> <span class="n">valid_scores</span><span class="p">],</span>
                <span class="n">metric_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Training MSE&quot;</span><span class="p">,</span> <span class="s2">&quot;Validation MSE&quot;</span><span class="p">],</span>
                <span class="n">x</span><span class="o">=</span><span class="n">plot_epoch_numbers</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;multitask_regression_training_curves.png&quot;</span>
                <span class="k">if</span> <span class="n">unique_string</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;multitask_regression_training_curves_</span><span class="si">{</span><span class="n">unique_string</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>


<span class="k">def</span><span class="w"> </span><span class="nf">fit_mtr_pytorch_model_per_task</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">torch_models</span><span class="o">.</span><span class="n">torch_model</span><span class="o">.</span><span class="n">TorchModel</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
    <span class="n">valid_dataset</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">unique_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">torch_models</span><span class="o">.</span><span class="n">torch_model</span><span class="o">.</span><span class="n">TorchModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to fit a multitask regressor pytorch model using the deepchem library.</span>
<span class="sd">    Args:</span>
<span class="sd">        model (dc.models.torch_models.torch_model.TorchModel): the model to train</span>
<span class="sd">        train_dataset (dc.data.data_loader.DataLoader): the training dataset</span>
<span class="sd">        valid_dataset (dc.data.data_loader.DataLoader): the validation dataset</span>
<span class="sd">        epochs (int): the number of epochs to train for</span>
<span class="sd">        unique_string (Optional[str]): a unique string to append to the output files</span>
<span class="sd">    Returns:</span>
<span class="sd">        dc.models.torch_models.torch_model.TorchModel: the trained model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">torch</span><span class="o">.</span><span class="n">use_deterministic_algorithms</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># train the model using an explicit loop to allow for intermediate evaluation</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">))</span>
    <span class="n">train_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">valid_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">plot_epoch_numbers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean-mean_squared_error&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>
    <span class="n">vs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean-mean_squared_error&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Processing epoch </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: latest train MSE (L2-loss) mean over tasks </span><span class="si">{</span><span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean-mean_squared_error&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> lastest validation MSE (L2-loss) mean over tasks </span><span class="si">{</span><span class="n">vs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean-mean_squared_error&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> tasks according to the shape of the y array&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">ith</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit_task</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">ith</span><span class="p">,</span> <span class="n">nb_epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">epochs</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
                <span class="n">train_dataset</span><span class="p">,</span>
                <span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)],</span>
            <span class="p">)</span>
            <span class="n">train_scores</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">items</span><span class="p">()][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
                <span class="n">valid_dataset</span><span class="p">,</span>
                <span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)],</span>
            <span class="p">)</span>
            <span class="n">valid_scores</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="o">.</span><span class="n">items</span><span class="p">()][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">plot_epoch_numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train scores epoch </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">train_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation scores epoch </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">valid_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">evaluate</span><span class="o">.</span><span class="n">plot_metric_curves</span><span class="p">(</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">train_scores</span><span class="p">,</span> <span class="n">valid_scores</span><span class="p">],</span>
                <span class="n">metric_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Training MSE&quot;</span><span class="p">,</span> <span class="s2">&quot;Validation MSE&quot;</span><span class="p">],</span>
                <span class="n">x</span><span class="o">=</span><span class="n">plot_epoch_numbers</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;multitask_regression_training_curves.png&quot;</span>
                <span class="k">if</span> <span class="n">unique_string</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;multitask_regression_training_curves_</span><span class="si">{</span><span class="n">unique_string</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>


<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_mtr_pytorch_model</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">torch_models</span><span class="o">.</span><span class="n">torch_model</span><span class="o">.</span><span class="n">TorchModel</span><span class="p">,</span>
    <span class="n">test_dataset</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
    <span class="n">tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">unique_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to evaluate a multitask regressor pytorch model using the deepchem library.</span>
<span class="sd">    Args:</span>

<span class="sd">        model (dc.models.torch_models.torch_model.TorchModel): the model to evaluate</span>
<span class="sd">        test_dataset (dc.data.data_loader.DataLoader): the test dataset</span>
<span class="sd">        tasks (List[str]): the names of the tasks to evaluate</span>
<span class="sd">        unique_string (Optional[str]): a unique string to append to the output files</span>
<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: the test set metrics predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># evaluate the model</span>
    <span class="n">avg_rms</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">rms_score</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">r2_score</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">avg_perarson_r2</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">pearson_r2_score</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">avg_mae</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">mae_score</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">avg_mape</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span>
        <span class="n">mean_absolute_percentage_error</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;regression&quot;</span>
    <span class="p">)</span>

    <span class="c1"># get the test set mean scores over tasks</span>
    <span class="n">test_scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
        <span class="n">test_dataset</span><span class="p">,</span>
        <span class="p">[</span><span class="n">avg_rms</span><span class="p">,</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="n">avg_perarson_r2</span><span class="p">,</span> <span class="n">avg_mae</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test scores: </span><span class="si">{</span><span class="n">test_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># get the test set predictions</span>
    <span class="n">test_set_prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span>

    <span class="c1"># get the test set mean scores over tasks and per task scores</span>
    <span class="n">mean_rmse_over_tasks</span><span class="p">,</span> <span class="n">rmses</span> <span class="o">=</span> <span class="n">avg_rms</span><span class="o">.</span><span class="n">compute_metric</span><span class="p">(</span>
        <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">test_set_prediction</span><span class="p">,</span> <span class="n">per_task_metrics</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">mean_cod_r2_over_tasks</span><span class="p">,</span> <span class="n">cod_r2s</span> <span class="o">=</span> <span class="n">avg_r2</span><span class="o">.</span><span class="n">compute_metric</span><span class="p">(</span>
        <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">test_set_prediction</span><span class="p">,</span> <span class="n">per_task_metrics</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">mean_pearsonr2_over_tasks</span><span class="p">,</span> <span class="n">perarson_r2s</span> <span class="o">=</span> <span class="n">avg_perarson_r2</span><span class="o">.</span><span class="n">compute_metric</span><span class="p">(</span>
        <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">test_set_prediction</span><span class="p">,</span> <span class="n">per_task_metrics</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">mean_mae_over_tasks</span><span class="p">,</span> <span class="n">maes</span> <span class="o">=</span> <span class="n">avg_mae</span><span class="o">.</span><span class="n">compute_metric</span><span class="p">(</span>
        <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">test_set_prediction</span><span class="p">,</span> <span class="n">per_task_metrics</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">mean_mape_over_tasks</span><span class="p">,</span> <span class="n">mapes</span> <span class="o">=</span> <span class="n">avg_mape</span><span class="o">.</span><span class="n">compute_metric</span><span class="p">(</span>
        <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">test_set_prediction</span><span class="p">,</span> <span class="n">per_task_metrics</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">test_set_metric_table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;RMS&quot;</span><span class="p">,</span> <span class="s2">&quot;R2&quot;</span><span class="p">,</span> <span class="s2">&quot;Pearson R2&quot;</span><span class="p">,</span> <span class="s2">&quot;MAE&quot;</span><span class="p">,</span> <span class="s2">&quot;MAPE&quot;</span><span class="p">],</span>
        <span class="p">[</span>
            <span class="n">mean_rmse_over_tasks</span><span class="p">,</span>
            <span class="n">mean_cod_r2_over_tasks</span><span class="p">,</span>
            <span class="n">mean_pearsonr2_over_tasks</span><span class="p">,</span>
            <span class="n">mean_mae_over_tasks</span><span class="p">,</span>
            <span class="n">mean_mape_over_tasks</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span><span class="n">rmses</span><span class="p">,</span> <span class="n">cod_r2s</span><span class="p">,</span> <span class="n">perarson_r2s</span><span class="p">,</span> <span class="n">maes</span><span class="p">,</span> <span class="n">mapes</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="c1"># log.info(f&quot;{metric} {values}&quot;)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Test </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> mean cross task score: </span><span class="si">{</span><span class="n">means</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> per task: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;Task </span><span class="si">{</span><span class="n">tasks</span><span class="p">[</span><span class="n">ith</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ith</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">)])</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">test_set_metric_table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">metric</span><span class="p">,</span> <span class="n">means</span><span class="p">]</span> <span class="o">+</span> <span class="n">values</span><span class="p">)</span>
    <span class="n">test_set_metric_table_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">test_set_metric_table</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">,</span> <span class="s2">&quot;mean over tasks&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">ent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">test_set_metric_table_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;metric&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">test_set_metric_table_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
        <span class="s2">&quot;multitask_regression_test_set_metric_table.csv&quot;</span>
        <span class="k">if</span> <span class="n">unique_string</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;multitask_regression_test_set_metric_table_</span><span class="si">{</span><span class="n">unique_string</span><span class="si">}</span><span class="s2">.csv&quot;</span>
    <span class="p">)</span>

    <span class="c1"># plot the parity plot of the predictions</span>
    <span class="k">for</span> <span class="n">ith_task</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">test_set_prediction</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">])</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">test_set_prediction</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">parity_plot</span><span class="p">(</span>
            <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">],</span>
            <span class="n">test_set_prediction</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;multitask_regression_task_</span><span class="si">{</span><span class="n">ith_task</span><span class="si">}</span><span class="s2">_test_set_parity_plot.png&quot;</span>
            <span class="k">if</span> <span class="n">unique_string</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;multitask_regression_task_</span><span class="si">{</span><span class="n">ith_task</span><span class="si">}</span><span class="s2">_test_set_parity_plot_</span><span class="si">{</span><span class="n">unique_string</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">plot_residuals</span><span class="p">(</span>
            <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">],</span>
            <span class="n">test_set_prediction</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;multitask_regression_task_</span><span class="si">{</span><span class="n">ith_task</span><span class="si">}</span><span class="s2">_test_set_resdual_plot.png&quot;</span>
            <span class="k">if</span> <span class="n">unique_string</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;multitask_regression_task_</span><span class="si">{</span><span class="n">ith_task</span><span class="si">}</span><span class="s2">_test_set_residual_plot_</span><span class="si">{</span><span class="n">unique_string</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">plot_qq</span><span class="p">(</span>
            <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">],</span>
            <span class="n">test_set_prediction</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;multitask_regression_task_</span><span class="si">{</span><span class="n">ith_task</span><span class="si">}</span><span class="s2">_test_set_qq_plot.png&quot;</span>
            <span class="k">if</span> <span class="n">unique_string</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;multitask_regression_task_</span><span class="si">{</span><span class="n">ith_task</span><span class="si">}</span><span class="s2">_test_set_qq_plot_</span><span class="si">{</span><span class="n">unique_string</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">test_set_metric_table_df</span>


<span class="k">def</span><span class="w"> </span><span class="nf">train_multitask_regressor</span><span class="p">(</span>
    <span class="n">tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">data_df</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">smiles_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;smiles&quot;</span><span class="p">,</span>
    <span class="n">ids_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">task_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">,</span>
    <span class="n">layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">featurizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">Featurizer</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">CircularFingerprint</span><span class="p">(</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">chiral</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bonds</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">),</span>
    <span class="n">splitter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">Splitter</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">RandomSplitter</span><span class="p">(),</span>
    <span class="n">unique_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fit_transformers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">Transformer</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pre_seed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">frac_train</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">frac_valid</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">frac_test</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">uncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">residual</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">weight_decay_penalty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">weight_decay_penalty_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;l2&quot;</span><span class="p">,</span>
    <span class="n">dropouts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">activation_fns</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Callable</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">test_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">valid_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to train a multitask regressor using the deepchem library.</span>
<span class="sd">    Note the deepchem library is a wrapper around pytorch, Jax, tensorflow and keras.</span>

<span class="sd">    The examples online are unclear for the use of this model so this function is a wrapper to make it easier to use.</span>
<span class="sd">    The main difficulty is building the data set. By default the dispite naming the tasks when you define teh loader</span>
<span class="sd">    object it does not by defult pull these out as the tasks. In addition, the weights in the data set for each data</span>
<span class="sd">    point default to 0.0. Both of these mean that there are no target values for the model to train on.</span>
<span class="sd">    The symptom this is happening is a continous average loss of 0.0.</span>

<span class="sd">    It seem that one has to explicitly add these to the data set when running .create_dataset(). However again this is not clear</span>
<span class="sd">    as the fucntion signature does not have keys for these values. Instead it assumes an order of SMILES, targets, weights, ids</span>
<span class="sd">    passed as an iterable. This is implemented in this function to make it easier to use and abstract the details of the interfaces</span>
<span class="sd">    of the deepchem library.</span>

<span class="sd">    Example:</span>
<span class="sd">    ```python</span>
<span class="sd">    import logging</span>
<span class="sd">    from redxregressors import deep_net_models</span>

<span class="sd">    dc_logger = logging.getLogger(&quot;deepchem&quot;)</span>
<span class="sd">    dc_logger.setLevel(logging.WARNING)</span>

<span class="sd">    data_df_bind = pd.read_csv(&quot;data/kinase_data_bind.csv&quot;)</span>
<span class="sd">    tasks = [&quot;kinase_1_pIC50&quot;, &quot;kinase_2_pIC50&quot;]</span>
<span class="sd">    smiles_column = &quot;smiles&quot;</span>
<span class="sd">    ids_column = &quot;name_id&quot;</span>

<span class="sd">    reg, tr, test, val, test_set_metrics_df = deep_net_models.train_multitask_regressor(</span>
<span class="sd">        data_df=data_df_bind,</span>
<span class="sd">        tasks=tasks,</span>
<span class="sd">        smiles_column=smiles_column,</span>
<span class="sd">        ids_column=ids_column,</span>
<span class="sd">        epochs=200,</span>
<span class="sd">        layer_sizes=[1000, 1000],</span>
<span class="sd">        )</span>
<span class="sd">    ```</span>

<span class="sd">    Args:</span>
<span class="sd">        data_df (pd.DataFrame): the data frame containing the data</span>
<span class="sd">        tasks (List[str]): the names of the tasks to train on</span>
<span class="sd">        smiles_column (str): the name of the column containing the SMILES strings</span>
<span class="sd">        ids_column (Optional[str]): the name of the column containing the IDs</span>
<span class="sd">        task_weights (Optional[List[float]]): the weights for each task</span>
<span class="sd">        epochs (int): the number of epochs to train for</span>
<span class="sd">        learning_rate (float): the learning rate for the model</span>
<span class="sd">        layer_sizes (List[int]): the sizes of the layers in the model</span>
<span class="sd">        batch_size (int): the batch size for the model</span>
<span class="sd">        featurizer (Optional[dc.feat.Featurizer]): the featurizer to use</span>
<span class="sd">        splitter (Optional[dc.splits.Splitter]): the splitter to use</span>
<span class="sd">        unique_string (Optional[str]): a unique string to append to the output files</span>
<span class="sd">        pre_seed (bool): whether to pre seed the random number generators</span>
<span class="sd">        frac_train (float): the fraction of the data to use for training</span>
<span class="sd">        frac_valid (float): the fraction of the data to use for validation</span>
<span class="sd">        frac_test (float): the fraction of the data to use for testing</span>
<span class="sd">        uncertainty (bool): whether to use uncertainty in the model</span>
<span class="sd">        residual (bool): whether to use residual connections in the model</span>
<span class="sd">        weight_decay_penalty (float): the weight decay penalty to use</span>
<span class="sd">        weight_decay_penalty_type (str): the type of weight decay penalty to use</span>
<span class="sd">        dropouts (float | Sequence[float]): the dropouts to use</span>
<span class="sd">        activation_fns (Callable | str | Sequence[Callable | str]): the activation functions to use</span>
<span class="sd">        **kwargs: additional keyword arguments to pass to the model</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[Any, Any, Any, Any, pd.DataFrame]: the trained model, the training data set, the validation data set, the test data set, tests set metrics predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Pre seed the random number generators</span>
    <span class="k">if</span> <span class="n">pre_seed</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">seed_all</span><span class="p">()</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">use_deterministic_algorithms</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get all of the pieces that form the data set as rew data</span>
    <span class="k">if</span> <span class="n">train_dataset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">test_dataset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">valid_dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Building the data sets from pandas data frame input and column headers&quot;</span>
        <span class="p">)</span>
        <span class="n">smiles</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">smiles_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="n">ids_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">ids_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="n">task_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">tw</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">task_weights</span><span class="p">):</span>
                <span class="n">weights</span><span class="p">[:,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">*=</span> <span class="n">task_weights</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Only one task was provided, this is not a multitask model consider a different model type&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">tasks</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># get the data sets for training, validation and testing</span>
        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">splitter</span> <span class="o">=</span> <span class="n">build_in_memory_loader</span><span class="p">(</span>
            <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span>
            <span class="n">featurizer</span><span class="o">=</span><span class="n">featurizer</span><span class="p">,</span>
            <span class="n">ids_column</span><span class="o">=</span><span class="n">ids_column</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="n">smiles</span><span class="o">=</span><span class="n">smiles</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
            <span class="n">splitter</span><span class="o">=</span><span class="n">splitter</span><span class="p">,</span>
            <span class="n">frac_train</span><span class="o">=</span><span class="n">frac_train</span><span class="p">,</span>
            <span class="n">frac_valid</span><span class="o">=</span><span class="n">frac_valid</span><span class="p">,</span>
            <span class="n">frac_test</span><span class="o">=</span><span class="n">frac_test</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># if the data sets are provided then use them</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using the provided data sets&quot;</span><span class="p">)</span>
        <span class="n">splitter</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training dataset shape: </span><span class="si">{</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># instantiate the model</span>
    <span class="k">if</span> <span class="n">fit_transformers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">MultitaskRegressor</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">),</span>
            <span class="n">train_dataset</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">layer_sizes</span><span class="o">=</span><span class="n">layer_sizes</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
            <span class="n">weight_decay_penalty</span><span class="o">=</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
            <span class="n">weight_decay_penalty_type</span><span class="o">=</span><span class="n">weight_decay_penalty_type</span><span class="p">,</span>
            <span class="n">dropouts</span><span class="o">=</span><span class="n">dropouts</span><span class="p">,</span>
            <span class="n">activation_fns</span><span class="o">=</span><span class="n">activation_fns</span><span class="p">,</span>
            <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty</span><span class="p">,</span>
            <span class="n">residual</span><span class="o">=</span><span class="n">residual</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fit_transformers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ent</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">transform_X</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform_y</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">fit_transformers</span>
        <span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">MultitaskFitTransformRegressor</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">),</span>
            <span class="n">train_dataset</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">layer_sizes</span><span class="o">=</span><span class="n">layer_sizes</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
            <span class="n">weight_decay_penalty</span><span class="o">=</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
            <span class="n">weight_decay_penalty_type</span><span class="o">=</span><span class="n">weight_decay_penalty_type</span><span class="p">,</span>
            <span class="n">dropouts</span><span class="o">=</span><span class="n">dropouts</span><span class="p">,</span>
            <span class="n">activation_fns</span><span class="o">=</span><span class="n">activation_fns</span><span class="p">,</span>
            <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty</span><span class="p">,</span>
            <span class="n">residual</span><span class="o">=</span><span class="n">residual</span><span class="p">,</span>
            <span class="n">fit_transformers</span><span class="o">=</span><span class="n">fit_transformers</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># train the model using an explicit loop to allow for intermediate evaluation</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">fit_mtr_pytorch_model</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
        <span class="n">valid_dataset</span><span class="o">=</span><span class="n">valid_dataset</span><span class="p">,</span>
        <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
        <span class="n">unique_string</span><span class="o">=</span><span class="n">unique_string</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># evaluate the model using the test set</span>
    <span class="n">test_set_df</span> <span class="o">=</span> <span class="n">evaluate_mtr_pytorch_model</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">test_dataset</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span> <span class="n">unique_string</span><span class="o">=</span><span class="n">unique_string</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">test_set_df</span>


<span class="k">def</span><span class="w"> </span><span class="nf">train_progressive_multitask_regressor</span><span class="p">(</span>
    <span class="n">data_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">smiles_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;smiles&quot;</span><span class="p">,</span>
    <span class="n">ids_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">task_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">,</span>
    <span class="n">layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">featurizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">Featurizer</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">CircularFingerprint</span><span class="p">(</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">chiral</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bonds</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">),</span>
    <span class="n">splitter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">Splitter</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">RandomSplitter</span><span class="p">(),</span>
    <span class="n">unique_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pre_seed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">frac_train</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">frac_valid</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">frac_test</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">uncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">residual</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">weight_decay_penalty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">weight_decay_penalty_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;l2&quot;</span><span class="p">,</span>
    <span class="n">dropouts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">activation_fns</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Callable</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span>
    <span class="n">train_per_task</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to train a multitask regressor using the deepchem library.</span>
<span class="sd">    Note the deepchem library is a wrapper around pytorch, Jax, tensorflow and keras.</span>

<span class="sd">    The examples online are unclear for the use of this model so this function is a wrapper to make it easier to use.</span>
<span class="sd">    The main difficulty is building the data set. By default the dispite naming the tasks when you define teh loader</span>
<span class="sd">    object it does not by defult pull these out as the tasks. In addition, the weights in the data set for each data</span>
<span class="sd">    point default to 0.0. Both of these mean that there are no target values for the model to train on.</span>
<span class="sd">    The symptom this is happening is a continous average loss of 0.0.</span>

<span class="sd">    It seem that one has to explicitly add these to the data set when running .create_dataset(). However again this is not clear</span>
<span class="sd">    as the fucntion signature does not have keys for these values. Instead it assumes an order of SMILES, targets, weights, ids</span>
<span class="sd">    passed as an iterable. This is implemented in this function to make it easier to use and abstract the details of the interfaces</span>
<span class="sd">    of the deepchem library.</span>

<span class="sd">    Example:</span>
<span class="sd">    ```python</span>
<span class="sd">    import logging</span>
<span class="sd">    from redxregressors import deep_net_models</span>

<span class="sd">    dc_logger = logging.getLogger(&quot;deepchem&quot;)</span>
<span class="sd">    dc_logger.setLevel(logging.WARNING)</span>

<span class="sd">    data_df_bind = pd.read_csv(&quot;data/kinase_data_bind.csv&quot;)</span>
<span class="sd">    tasks = [&quot;kinase_1_pIC50&quot;, &quot;kinase_2_pIC50&quot;]</span>
<span class="sd">    smiles_column = &quot;smiles&quot;</span>
<span class="sd">    ids_column = &quot;name_id&quot;</span>

<span class="sd">    reg, tr, test, val, test_set_metrics_df = deep_net_models.train_multitask_regressor(</span>
<span class="sd">        data_df=data_df_bind,</span>
<span class="sd">        tasks=tasks,</span>
<span class="sd">        smiles_column=smiles_column,</span>
<span class="sd">        ids_column=ids_column,</span>
<span class="sd">        epochs=200,</span>
<span class="sd">        layer_sizes=[1000, 1000],</span>
<span class="sd">        )</span>
<span class="sd">    ```</span>

<span class="sd">    Args:</span>
<span class="sd">        data_df (pd.DataFrame): the data frame containing the data</span>
<span class="sd">        tasks (List[str]): the names of the tasks to train on</span>
<span class="sd">        smiles_column (str): the name of the column containing the SMILES strings</span>
<span class="sd">        ids_column (Optional[str]): the name of the column containing the IDs</span>
<span class="sd">        task_weights (Optional[List[float]]): the weights for each task</span>
<span class="sd">        epochs (int): the number of epochs to train for</span>
<span class="sd">        learning_rate (float): the learning rate for the model</span>
<span class="sd">        layer_sizes (List[int]): the sizes of the layers in the model</span>
<span class="sd">        batch_size (int): the batch size for the model</span>
<span class="sd">        featurizer (Optional[dc.feat.Featurizer]): the featurizer to use</span>
<span class="sd">        splitter (Optional[dc.splits.Splitter]): the splitter to use</span>
<span class="sd">        unique_string (Optional[str]): a unique string to append to the output files</span>
<span class="sd">        pre_seed (bool): whether to pre seed the random number generators</span>
<span class="sd">        frac_train (float): the fraction of the data to use for training</span>
<span class="sd">        frac_valid (float): the fraction of the data to use for validation</span>
<span class="sd">        frac_test (float): the fraction of the data to use for testing</span>
<span class="sd">        uncertainty (bool): whether to use uncertainty in the model</span>
<span class="sd">        residual (bool): whether to use residual connections in the model</span>
<span class="sd">        weight_decay_penalty (float): the weight decay penalty to use</span>
<span class="sd">        weight_decay_penalty_type (str): the type of weight decay penalty to use</span>
<span class="sd">        dropouts (float | Sequence[float]): the dropouts to use</span>
<span class="sd">        activation_fns (Callable | str | Sequence[Callable | str]): the activation functions to use</span>
<span class="sd">        train_per_task (bool): whether to train the model per task sequentially</span>
<span class="sd">        **kwargs: additional keyword arguments to pass to the model</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[Any, Any, Any, Any, pd.DataFrame]: the trained model, the training data set, the validation data set, the test data set, tests set metrics predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Pre seed the random number generators</span>
    <span class="k">if</span> <span class="n">pre_seed</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">seed_all</span><span class="p">()</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">use_deterministic_algorithms</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get all of the pieces that form the data set as rew data</span>
    <span class="n">smiles</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">smiles_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="n">ids_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">ids_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="n">task_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">tw</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">task_weights</span><span class="p">):</span>
            <span class="n">weights</span><span class="p">[:,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">*=</span> <span class="n">task_weights</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Only one task was provided, this is not a multitask model consider a different model type&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">tasks</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># get the data sets for training, validation and testing</span>
    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">splitter</span> <span class="o">=</span> <span class="n">build_in_memory_loader</span><span class="p">(</span>
        <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span>
        <span class="n">featurizer</span><span class="o">=</span><span class="n">featurizer</span><span class="p">,</span>
        <span class="n">ids_column</span><span class="o">=</span><span class="n">ids_column</span><span class="p">,</span>
        <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
        <span class="n">smiles</span><span class="o">=</span><span class="n">smiles</span><span class="p">,</span>
        <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
        <span class="n">splitter</span><span class="o">=</span><span class="n">splitter</span><span class="p">,</span>
        <span class="n">frac_train</span><span class="o">=</span><span class="n">frac_train</span><span class="p">,</span>
        <span class="n">frac_valid</span><span class="o">=</span><span class="n">frac_valid</span><span class="p">,</span>
        <span class="n">frac_test</span><span class="o">=</span><span class="n">frac_test</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training dataset shape: </span><span class="si">{</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># instantiate the model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">torch_models</span><span class="o">.</span><span class="n">ProgressiveMultitaskModel</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">),</span>
        <span class="n">train_dataset</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;regression&quot;</span><span class="p">,</span>
        <span class="n">layer_sizes</span><span class="o">=</span><span class="n">layer_sizes</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
        <span class="n">weight_decay_penalty</span><span class="o">=</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
        <span class="n">weight_decay_penalty_type</span><span class="o">=</span><span class="n">weight_decay_penalty_type</span><span class="p">,</span>
        <span class="n">dropouts</span><span class="o">=</span><span class="n">dropouts</span><span class="p">,</span>
        <span class="n">activation_fns</span><span class="o">=</span><span class="n">activation_fns</span><span class="p">,</span>
        <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty</span><span class="p">,</span>
        <span class="n">residual</span><span class="o">=</span><span class="n">residual</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># train the model using an explicit loop to allow for intermediate evaluation</span>
    <span class="k">if</span> <span class="n">train_per_task</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">fit_mtr_pytorch_model</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">valid_dataset</span><span class="o">=</span><span class="n">valid_dataset</span><span class="p">,</span>
            <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
            <span class="n">unique_string</span><span class="o">=</span><span class="n">unique_string</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fit_mtr_pytorch_model_per_task</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">valid_dataset</span><span class="o">=</span><span class="n">valid_dataset</span><span class="p">,</span>
            <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
            <span class="n">unique_string</span><span class="o">=</span><span class="n">unique_string</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># evaluate the model using the test set</span>
    <span class="n">test_set_df</span> <span class="o">=</span> <span class="n">evaluate_mtr_pytorch_model</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">test_dataset</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span> <span class="n">unique_string</span><span class="o">=</span><span class="n">unique_string</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">test_set_df</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">doctest</span>

    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">
    <h2 class="section-title" id="header-variables">Module variables</h2>
      <div class="item">
      <p id="redxregressors.deep_net_models.log" class="name">var <span class="ident">log</span></p>


  <div class="source_cont">
</div>

      </div>

    <h2 class="section-title" id="header-functions">Functions</h2>

  <div class="item">
    <div class="name def" id="redxregressors.deep_net_models.build_in_memory_loader">
    <p>def <span class="ident">build_in_memory_loader</span>(</p><p>tasks: Union[numpy._typing._array_like._SupportsArray[numpy.dtype[Any]], numpy._typing._nested_sequence._NestedSequence[numpy._typing._array_like._SupportsArray[numpy.dtype[Any]]], bool, int, float, complex, str, bytes, numpy._typing._nested_sequence._NestedSequence[bool | int | float | complex | str | bytes]], featurizer: deepchem.feat.base_classes.Featurizer, ids_column: str, ids: Union[numpy._typing._array_like._SupportsArray[numpy.dtype[Any]], numpy._typing._nested_sequence._NestedSequence[numpy._typing._array_like._SupportsArray[numpy.dtype[Any]]], bool, int, float, complex, str, bytes, numpy._typing._nested_sequence._NestedSequence[bool | int | float | complex | str | bytes]], smiles: Union[numpy._typing._array_like._SupportsArray[numpy.dtype[Any]], numpy._typing._nested_sequence._NestedSequence[numpy._typing._array_like._SupportsArray[numpy.dtype[Any]]], bool, int, float, complex, str, bytes, numpy._typing._nested_sequence._NestedSequence[bool | int | float | complex | str | bytes]], targets: Union[numpy._typing._array_like._SupportsArray[numpy.dtype[Any]], numpy._typing._nested_sequence._NestedSequence[numpy._typing._array_like._SupportsArray[numpy.dtype[Any]]], bool, int, float, complex, str, bytes, numpy._typing._nested_sequence._NestedSequence[bool | int | float | complex | str | bytes]], weights: Union[numpy._typing._array_like._SupportsArray[numpy.dtype[Any]], numpy._typing._nested_sequence._NestedSequence[numpy._typing._array_like._SupportsArray[numpy.dtype[Any]]], bool, int, float, complex, str, bytes, numpy._typing._nested_sequence._NestedSequence[bool | int | float | complex | str | bytes]], splitter: Optional[deepchem.splits.splitters.Splitter] = None, frac_train: float = 0.8, frac_valid: float = 0.1, frac_test: float = 0.1)</p>
    </div>




    <div class="desc"><p>Function to build the in memory loader for the deepchem multitask regressor model.
Args:
    tasks (List[str]): the names of the tasks to train on
    featurizer (dc.feat.Featurizer): the featurizer to use
    ids_column (Optional[str]): the name of the column containing the IDs
    smiles (List[str]): the SMILES strings
    targets (np.ndarray): the target values
    weights (np.ndarray): the weights for each task
    splitter (Optional[dc.splits.Splitter]): the splitter to use
Returns:
    tuple: the training, validation and testing datasets and the splitter object if a splitter was provided otherwise the dataset and None, None, None</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-redxregressors.deep_net_models.build_in_memory_loader', this);">Show source &equiv;</a></p>
  <div id="source-redxregressors.deep_net_models.build_in_memory_loader" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">build_in_memory_loader</span><span class="p">(</span>
    <span class="n">tasks</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">featurizer</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">Featurizer</span><span class="p">,</span>
    <span class="n">ids_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ids</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">smiles</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">targets</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">splitter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">Splitter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">frac_train</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">frac_valid</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">frac_test</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to build the in memory loader for the deepchem multitask regressor model.</span>
<span class="sd">    Args:</span>
<span class="sd">        tasks (List[str]): the names of the tasks to train on</span>
<span class="sd">        featurizer (dc.feat.Featurizer): the featurizer to use</span>
<span class="sd">        ids_column (Optional[str]): the name of the column containing the IDs</span>
<span class="sd">        smiles (List[str]): the SMILES strings</span>
<span class="sd">        targets (np.ndarray): the target values</span>
<span class="sd">        weights (np.ndarray): the weights for each task</span>
<span class="sd">        splitter (Optional[dc.splits.Splitter]): the splitter to use</span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: the training, validation and testing datasets and the splitter object if a splitter was provided otherwise the dataset and None, None, None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">torch</span><span class="o">.</span><span class="n">use_deterministic_algorithms</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create the loader object to load the data into the model from memory</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">InMemoryLoader</span><span class="p">(</span>
        <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span>
        <span class="n">featurizer</span><span class="o">=</span><span class="n">featurizer</span><span class="p">,</span>
        <span class="n">id_field</span><span class="o">=</span><span class="n">ids_column</span><span class="p">,</span>
        <span class="n">log_every_n</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Create the dataset object</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">ids</span><span class="p">),</span> <span class="n">shard_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">splitter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Split the dataset into training, validation and testing sets</span>
        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">splitter</span><span class="o">.</span><span class="n">train_valid_test_split</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="n">frac_train</span><span class="o">=</span><span class="n">frac_train</span><span class="p">,</span>
            <span class="n">frac_valid</span><span class="o">=</span><span class="n">frac_valid</span><span class="p">,</span>
            <span class="n">frac_test</span><span class="o">=</span><span class="n">frac_test</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span>
            <span class="n">log_every_n</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">splitter</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</pre></div>

  </div>
</div>

  </div>


  <div class="item">
    <div class="name def" id="redxregressors.deep_net_models.build_in_memory_loader_using_dataframe">
    <p>def <span class="ident">build_in_memory_loader_using_dataframe</span>(</p><p>df: pandas.core.frame.DataFrame, task_columns: List[str], featurizer: deepchem.feat.base_classes.Featurizer, ids_column: str, smiles_column: str, weights: Union[numpy._typing._array_like._SupportsArray[numpy.dtype[Any]], numpy._typing._nested_sequence._NestedSequence[numpy._typing._array_like._SupportsArray[numpy.dtype[Any]]], bool, int, float, complex, str, bytes, numpy._typing._nested_sequence._NestedSequence[bool | int | float | complex | str | bytes], NoneType] = None, splitter: Optional[deepchem.splits.splitters.Splitter] = None, frac_train: float = 0.8, frac_valid: float = 0.1, frac_test: float = 0.1)</p>
    </div>




    <div class="desc"><p>Function to build the in memory loader for the deepchem multitask regressor model.
Args:
    tasks (List[str]): the names of the tasks to train on
    featurizer (dc.feat.Featurizer): the featurizer to use
    ids_column (Optional[str]): the name of the column containing the IDs
    smiles (List[str]): the SMILES strings
    targets (np.ndarray): the target values
    weights (np.ndarray): the weights for each task
    splitter (Optional[dc.splits.Splitter]): the splitter to use
Returns:
    tuple: the training, validation and testing datasets and the splitter object if a splitter was provided otherwise the dataset and None, None, None</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-redxregressors.deep_net_models.build_in_memory_loader_using_dataframe', this);">Show source &equiv;</a></p>
  <div id="source-redxregressors.deep_net_models.build_in_memory_loader_using_dataframe" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">build_in_memory_loader_using_dataframe</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">task_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">featurizer</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">Featurizer</span><span class="p">,</span>
    <span class="n">ids_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">smiles_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">splitter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">Splitter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">frac_train</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">frac_valid</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">frac_test</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to build the in memory loader for the deepchem multitask regressor model.</span>
<span class="sd">    Args:</span>
<span class="sd">        tasks (List[str]): the names of the tasks to train on</span>
<span class="sd">        featurizer (dc.feat.Featurizer): the featurizer to use</span>
<span class="sd">        ids_column (Optional[str]): the name of the column containing the IDs</span>
<span class="sd">        smiles (List[str]): the SMILES strings</span>
<span class="sd">        targets (np.ndarray): the target values</span>
<span class="sd">        weights (np.ndarray): the weights for each task</span>
<span class="sd">        splitter (Optional[dc.splits.Splitter]): the splitter to use</span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple: the training, validation and testing datasets and the splitter object if a splitter was provided otherwise the dataset and None, None, None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">torch</span><span class="o">.</span><span class="n">use_deterministic_algorithms</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="n">task_columns</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">task_columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>

    <span class="n">smiles</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">smiles_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">ids_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Create the loader object to load the data into the model from memory</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">InMemoryLoader</span><span class="p">(</span>
        <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span>
        <span class="n">featurizer</span><span class="o">=</span><span class="n">featurizer</span><span class="p">,</span>
        <span class="n">id_field</span><span class="o">=</span><span class="n">ids_column</span><span class="p">,</span>
        <span class="n">log_every_n</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Create the dataset object</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">ids</span><span class="p">),</span> <span class="n">shard_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">splitter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Split the dataset into training, validation and testing sets</span>
        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">splitter</span><span class="o">.</span><span class="n">train_valid_test_split</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="n">frac_train</span><span class="o">=</span><span class="n">frac_train</span><span class="p">,</span>
            <span class="n">frac_valid</span><span class="o">=</span><span class="n">frac_valid</span><span class="p">,</span>
            <span class="n">frac_test</span><span class="o">=</span><span class="n">frac_test</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">utilities</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span>
            <span class="n">log_every_n</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">splitter</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</pre></div>

  </div>
</div>

  </div>


  <div class="item">
    <div class="name def" id="redxregressors.deep_net_models.evaluate_mtr_pytorch_model">
    <p>def <span class="ident">evaluate_mtr_pytorch_model</span>(</p><p>model: deepchem.models.torch_models.torch_model.TorchModel, test_dataset: deepchem.data.data_loader.DataLoader, tasks: List[str], unique_string: Optional[str] = None)</p>
    </div>




    <div class="desc"><p>Function to evaluate a multitask regressor pytorch model using the deepchem library.
Args:</p>
<pre><code>model (dc.models.torch_models.torch_model.TorchModel): the model to evaluate
test_dataset (dc.data.data_loader.DataLoader): the test dataset
tasks (List[str]): the names of the tasks to evaluate
unique_string (Optional[str]): a unique string to append to the output files
</code></pre>
<p>Returns:
    pd.DataFrame: the test set metrics predictions</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-redxregressors.deep_net_models.evaluate_mtr_pytorch_model', this);">Show source &equiv;</a></p>
  <div id="source-redxregressors.deep_net_models.evaluate_mtr_pytorch_model" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_mtr_pytorch_model</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">torch_models</span><span class="o">.</span><span class="n">torch_model</span><span class="o">.</span><span class="n">TorchModel</span><span class="p">,</span>
    <span class="n">test_dataset</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
    <span class="n">tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">unique_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to evaluate a multitask regressor pytorch model using the deepchem library.</span>
<span class="sd">    Args:</span>

<span class="sd">        model (dc.models.torch_models.torch_model.TorchModel): the model to evaluate</span>
<span class="sd">        test_dataset (dc.data.data_loader.DataLoader): the test dataset</span>
<span class="sd">        tasks (List[str]): the names of the tasks to evaluate</span>
<span class="sd">        unique_string (Optional[str]): a unique string to append to the output files</span>
<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: the test set metrics predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># evaluate the model</span>
    <span class="n">avg_rms</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">rms_score</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">avg_r2</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">r2_score</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">avg_perarson_r2</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">pearson_r2_score</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">avg_mae</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">mae_score</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">avg_mape</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span>
        <span class="n">mean_absolute_percentage_error</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;regression&quot;</span>
    <span class="p">)</span>

    <span class="c1"># get the test set mean scores over tasks</span>
    <span class="n">test_scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
        <span class="n">test_dataset</span><span class="p">,</span>
        <span class="p">[</span><span class="n">avg_rms</span><span class="p">,</span> <span class="n">avg_r2</span><span class="p">,</span> <span class="n">avg_perarson_r2</span><span class="p">,</span> <span class="n">avg_mae</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test scores: </span><span class="si">{</span><span class="n">test_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># get the test set predictions</span>
    <span class="n">test_set_prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span>

    <span class="c1"># get the test set mean scores over tasks and per task scores</span>
    <span class="n">mean_rmse_over_tasks</span><span class="p">,</span> <span class="n">rmses</span> <span class="o">=</span> <span class="n">avg_rms</span><span class="o">.</span><span class="n">compute_metric</span><span class="p">(</span>
        <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">test_set_prediction</span><span class="p">,</span> <span class="n">per_task_metrics</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">mean_cod_r2_over_tasks</span><span class="p">,</span> <span class="n">cod_r2s</span> <span class="o">=</span> <span class="n">avg_r2</span><span class="o">.</span><span class="n">compute_metric</span><span class="p">(</span>
        <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">test_set_prediction</span><span class="p">,</span> <span class="n">per_task_metrics</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">mean_pearsonr2_over_tasks</span><span class="p">,</span> <span class="n">perarson_r2s</span> <span class="o">=</span> <span class="n">avg_perarson_r2</span><span class="o">.</span><span class="n">compute_metric</span><span class="p">(</span>
        <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">test_set_prediction</span><span class="p">,</span> <span class="n">per_task_metrics</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">mean_mae_over_tasks</span><span class="p">,</span> <span class="n">maes</span> <span class="o">=</span> <span class="n">avg_mae</span><span class="o">.</span><span class="n">compute_metric</span><span class="p">(</span>
        <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">test_set_prediction</span><span class="p">,</span> <span class="n">per_task_metrics</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">mean_mape_over_tasks</span><span class="p">,</span> <span class="n">mapes</span> <span class="o">=</span> <span class="n">avg_mape</span><span class="o">.</span><span class="n">compute_metric</span><span class="p">(</span>
        <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">test_set_prediction</span><span class="p">,</span> <span class="n">per_task_metrics</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">test_set_metric_table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;RMS&quot;</span><span class="p">,</span> <span class="s2">&quot;R2&quot;</span><span class="p">,</span> <span class="s2">&quot;Pearson R2&quot;</span><span class="p">,</span> <span class="s2">&quot;MAE&quot;</span><span class="p">,</span> <span class="s2">&quot;MAPE&quot;</span><span class="p">],</span>
        <span class="p">[</span>
            <span class="n">mean_rmse_over_tasks</span><span class="p">,</span>
            <span class="n">mean_cod_r2_over_tasks</span><span class="p">,</span>
            <span class="n">mean_pearsonr2_over_tasks</span><span class="p">,</span>
            <span class="n">mean_mae_over_tasks</span><span class="p">,</span>
            <span class="n">mean_mape_over_tasks</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span><span class="n">rmses</span><span class="p">,</span> <span class="n">cod_r2s</span><span class="p">,</span> <span class="n">perarson_r2s</span><span class="p">,</span> <span class="n">maes</span><span class="p">,</span> <span class="n">mapes</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="c1"># log.info(f&quot;{metric} {values}&quot;)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Test </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> mean cross task score: </span><span class="si">{</span><span class="n">means</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> per task: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;Task </span><span class="si">{</span><span class="n">tasks</span><span class="p">[</span><span class="n">ith</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ith</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">)])</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">test_set_metric_table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">metric</span><span class="p">,</span> <span class="n">means</span><span class="p">]</span> <span class="o">+</span> <span class="n">values</span><span class="p">)</span>
    <span class="n">test_set_metric_table_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">test_set_metric_table</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">,</span> <span class="s2">&quot;mean over tasks&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">ent</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">test_set_metric_table_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;metric&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">test_set_metric_table_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
        <span class="s2">&quot;multitask_regression_test_set_metric_table.csv&quot;</span>
        <span class="k">if</span> <span class="n">unique_string</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;multitask_regression_test_set_metric_table_</span><span class="si">{</span><span class="n">unique_string</span><span class="si">}</span><span class="s2">.csv&quot;</span>
    <span class="p">)</span>

    <span class="c1"># plot the parity plot of the predictions</span>
    <span class="k">for</span> <span class="n">ith_task</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">test_set_prediction</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">])</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">test_set_prediction</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">parity_plot</span><span class="p">(</span>
            <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">],</span>
            <span class="n">test_set_prediction</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;multitask_regression_task_</span><span class="si">{</span><span class="n">ith_task</span><span class="si">}</span><span class="s2">_test_set_parity_plot.png&quot;</span>
            <span class="k">if</span> <span class="n">unique_string</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;multitask_regression_task_</span><span class="si">{</span><span class="n">ith_task</span><span class="si">}</span><span class="s2">_test_set_parity_plot_</span><span class="si">{</span><span class="n">unique_string</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">plot_residuals</span><span class="p">(</span>
            <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">],</span>
            <span class="n">test_set_prediction</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;multitask_regression_task_</span><span class="si">{</span><span class="n">ith_task</span><span class="si">}</span><span class="s2">_test_set_resdual_plot.png&quot;</span>
            <span class="k">if</span> <span class="n">unique_string</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;multitask_regression_task_</span><span class="si">{</span><span class="n">ith_task</span><span class="si">}</span><span class="s2">_test_set_residual_plot_</span><span class="si">{</span><span class="n">unique_string</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">.</span><span class="n">plot_qq</span><span class="p">(</span>
            <span class="n">test_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">],</span>
            <span class="n">test_set_prediction</span><span class="p">[:,</span> <span class="n">ith_task</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;multitask_regression_task_</span><span class="si">{</span><span class="n">ith_task</span><span class="si">}</span><span class="s2">_test_set_qq_plot.png&quot;</span>
            <span class="k">if</span> <span class="n">unique_string</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;multitask_regression_task_</span><span class="si">{</span><span class="n">ith_task</span><span class="si">}</span><span class="s2">_test_set_qq_plot_</span><span class="si">{</span><span class="n">unique_string</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">test_set_metric_table_df</span>
</pre></div>

  </div>
</div>

  </div>


  <div class="item">
    <div class="name def" id="redxregressors.deep_net_models.fit_mtr_pytorch_model">
    <p>def <span class="ident">fit_mtr_pytorch_model</span>(</p><p>model: deepchem.models.torch_models.torch_model.TorchModel, train_dataset: deepchem.data.data_loader.DataLoader, valid_dataset: deepchem.data.data_loader.DataLoader, epochs: int = 100, unique_string: Optional[str] = None)</p>
    </div>




    <div class="desc"><p>Function to fit a multitask regressor pytorch model using the deepchem library.
Args:
    model (dc.models.torch_models.torch_model.TorchModel): the model to train
    train_dataset (dc.data.data_loader.DataLoader): the training dataset
    valid_dataset (dc.data.data_loader.DataLoader): the validation dataset
    epochs (int): the number of epochs to train for
    unique_string (Optional[str]): a unique string to append to the output files
Returns:
    dc.models.torch_models.torch_model.TorchModel: the trained model</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-redxregressors.deep_net_models.fit_mtr_pytorch_model', this);">Show source &equiv;</a></p>
  <div id="source-redxregressors.deep_net_models.fit_mtr_pytorch_model" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fit_mtr_pytorch_model</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">torch_models</span><span class="o">.</span><span class="n">torch_model</span><span class="o">.</span><span class="n">TorchModel</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
    <span class="n">valid_dataset</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">unique_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">torch_models</span><span class="o">.</span><span class="n">torch_model</span><span class="o">.</span><span class="n">TorchModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to fit a multitask regressor pytorch model using the deepchem library.</span>
<span class="sd">    Args:</span>
<span class="sd">        model (dc.models.torch_models.torch_model.TorchModel): the model to train</span>
<span class="sd">        train_dataset (dc.data.data_loader.DataLoader): the training dataset</span>
<span class="sd">        valid_dataset (dc.data.data_loader.DataLoader): the validation dataset</span>
<span class="sd">        epochs (int): the number of epochs to train for</span>
<span class="sd">        unique_string (Optional[str]): a unique string to append to the output files</span>
<span class="sd">    Returns:</span>
<span class="sd">        dc.models.torch_models.torch_model.TorchModel: the trained model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">torch</span><span class="o">.</span><span class="n">use_deterministic_algorithms</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># train the model using an explicit loop to allow for intermediate evaluation</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">))</span>
    <span class="n">train_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">valid_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">plot_epoch_numbers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean-mean_squared_error&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>
    <span class="n">vs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean-mean_squared_error&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Processing epoch </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: latest train MSE (L2-loss) mean over tasks </span><span class="si">{</span><span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean-mean_squared_error&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> lastest validation MSE (L2-loss) mean over tasks </span><span class="si">{</span><span class="n">vs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean-mean_squared_error&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">nb_epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">epochs</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
                <span class="n">train_dataset</span><span class="p">,</span>
                <span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)],</span>
            <span class="p">)</span>
            <span class="n">train_scores</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">items</span><span class="p">()][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
                <span class="n">valid_dataset</span><span class="p">,</span>
                <span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)],</span>
            <span class="p">)</span>
            <span class="n">valid_scores</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="o">.</span><span class="n">items</span><span class="p">()][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">plot_epoch_numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train scores epoch </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">train_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation scores epoch </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">valid_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">evaluate</span><span class="o">.</span><span class="n">plot_metric_curves</span><span class="p">(</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">train_scores</span><span class="p">,</span> <span class="n">valid_scores</span><span class="p">],</span>
                <span class="n">metric_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Training MSE&quot;</span><span class="p">,</span> <span class="s2">&quot;Validation MSE&quot;</span><span class="p">],</span>
                <span class="n">x</span><span class="o">=</span><span class="n">plot_epoch_numbers</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;multitask_regression_training_curves.png&quot;</span>
                <span class="k">if</span> <span class="n">unique_string</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;multitask_regression_training_curves_</span><span class="si">{</span><span class="n">unique_string</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</pre></div>

  </div>
</div>

  </div>


  <div class="item">
    <div class="name def" id="redxregressors.deep_net_models.fit_mtr_pytorch_model_per_task">
    <p>def <span class="ident">fit_mtr_pytorch_model_per_task</span>(</p><p>model: deepchem.models.torch_models.torch_model.TorchModel, train_dataset: deepchem.data.data_loader.DataLoader, valid_dataset: deepchem.data.data_loader.DataLoader, epochs: int = 100, unique_string: Optional[str] = None)</p>
    </div>




    <div class="desc"><p>Function to fit a multitask regressor pytorch model using the deepchem library.
Args:
    model (dc.models.torch_models.torch_model.TorchModel): the model to train
    train_dataset (dc.data.data_loader.DataLoader): the training dataset
    valid_dataset (dc.data.data_loader.DataLoader): the validation dataset
    epochs (int): the number of epochs to train for
    unique_string (Optional[str]): a unique string to append to the output files
Returns:
    dc.models.torch_models.torch_model.TorchModel: the trained model</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-redxregressors.deep_net_models.fit_mtr_pytorch_model_per_task', this);">Show source &equiv;</a></p>
  <div id="source-redxregressors.deep_net_models.fit_mtr_pytorch_model_per_task" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fit_mtr_pytorch_model_per_task</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">torch_models</span><span class="o">.</span><span class="n">torch_model</span><span class="o">.</span><span class="n">TorchModel</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
    <span class="n">valid_dataset</span><span class="p">:</span> <span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span>
    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">unique_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">torch_models</span><span class="o">.</span><span class="n">torch_model</span><span class="o">.</span><span class="n">TorchModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to fit a multitask regressor pytorch model using the deepchem library.</span>
<span class="sd">    Args:</span>
<span class="sd">        model (dc.models.torch_models.torch_model.TorchModel): the model to train</span>
<span class="sd">        train_dataset (dc.data.data_loader.DataLoader): the training dataset</span>
<span class="sd">        valid_dataset (dc.data.data_loader.DataLoader): the validation dataset</span>
<span class="sd">        epochs (int): the number of epochs to train for</span>
<span class="sd">        unique_string (Optional[str]): a unique string to append to the output files</span>
<span class="sd">    Returns:</span>
<span class="sd">        dc.models.torch_models.torch_model.TorchModel: the trained model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">torch</span><span class="o">.</span><span class="n">use_deterministic_algorithms</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># train the model using an explicit loop to allow for intermediate evaluation</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">))</span>
    <span class="n">train_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">valid_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">plot_epoch_numbers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean-mean_squared_error&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>
    <span class="n">vs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean-mean_squared_error&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Processing epoch </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: latest train MSE (L2-loss) mean over tasks </span><span class="si">{</span><span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean-mean_squared_error&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> lastest validation MSE (L2-loss) mean over tasks </span><span class="si">{</span><span class="n">vs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean-mean_squared_error&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> tasks according to the shape of the y array&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">ith</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fit_task</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">ith</span><span class="p">,</span> <span class="n">nb_epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">epochs</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
                <span class="n">train_dataset</span><span class="p">,</span>
                <span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)],</span>
            <span class="p">)</span>
            <span class="n">train_scores</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">items</span><span class="p">()][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
                <span class="n">valid_dataset</span><span class="p">,</span>
                <span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)],</span>
            <span class="p">)</span>
            <span class="n">valid_scores</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vs</span><span class="o">.</span><span class="n">items</span><span class="p">()][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">plot_epoch_numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train scores epoch </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">train_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation scores epoch </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">valid_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">evaluate</span><span class="o">.</span><span class="n">plot_metric_curves</span><span class="p">(</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">train_scores</span><span class="p">,</span> <span class="n">valid_scores</span><span class="p">],</span>
                <span class="n">metric_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Training MSE&quot;</span><span class="p">,</span> <span class="s2">&quot;Validation MSE&quot;</span><span class="p">],</span>
                <span class="n">x</span><span class="o">=</span><span class="n">plot_epoch_numbers</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;multitask_regression_training_curves.png&quot;</span>
                <span class="k">if</span> <span class="n">unique_string</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;multitask_regression_training_curves_</span><span class="si">{</span><span class="n">unique_string</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</pre></div>

  </div>
</div>

  </div>


  <div class="item">
    <div class="name def" id="redxregressors.deep_net_models.train_multitask_regressor">
    <p>def <span class="ident">train_multitask_regressor</span>(</p><p>tasks: List[str], data_df: Optional[pandas.core.frame.DataFrame] = None, smiles_column: str = &#39;smiles&#39;, ids_column: Optional[str] = None, task_weights: Optional[List[float]] = None, epochs: int = 100, learning_rate: float = 0.0001, layer_sizes: List[int] = [1000, 1000], batch_size: int = 50, featurizer: Optional[deepchem.feat.base_classes.Featurizer] = CircularFingerprint[radius=2, size=1024, chiral=True, bonds=True, features=False, sparse=False, smiles=False, is_counts_based=False], splitter: Optional[deepchem.splits.splitters.Splitter] = RandomSplitter[], unique_string: Optional[str] = None, fit_transformers: Optional[List[transformers.Transformer]] = None, pre_seed: bool = True, frac_train: float = 0.8, frac_valid: float = 0.1, frac_test: float = 0.1, uncertainty: bool = False, residual: bool = False, weight_decay_penalty: float = 0.0, weight_decay_penalty_type: str = &#39;l2&#39;, dropouts: Union[float, Sequence[float]] = 0.5, activation_fns: Union[Callable, str, Sequence[Union[Callable, str]]] = &#39;relu&#39;, train_dataset: Optional[deepchem.data.data_loader.DataLoader] = None, test_dataset: Optional[deepchem.data.data_loader.DataLoader] = None, valid_dataset: Optional[deepchem.data.data_loader.DataLoader] = None, **kwargs)</p>
    </div>




    <div class="desc"><p>Function to train a multitask regressor using the deepchem library.
Note the deepchem library is a wrapper around pytorch, Jax, tensorflow and keras.</p>
<p>The examples online are unclear for the use of this model so this function is a wrapper to make it easier to use.
The main difficulty is building the data set. By default the dispite naming the tasks when you define teh loader
object it does not by defult pull these out as the tasks. In addition, the weights in the data set for each data
point default to 0.0. Both of these mean that there are no target values for the model to train on.
The symptom this is happening is a continous average loss of 0.0.</p>
<p>It seem that one has to explicitly add these to the data set when running .create_dataset(). However again this is not clear
as the fucntion signature does not have keys for these values. Instead it assumes an order of SMILES, targets, weights, ids
passed as an iterable. This is implemented in this function to make it easier to use and abstract the details of the interfaces
of the deepchem library.</p>
<p>Example:</p>
<pre><code class="language-python">import logging
from redxregressors import deep_net_models

dc_logger = logging.getLogger(&quot;deepchem&quot;)
dc_logger.setLevel(logging.WARNING)

data_df_bind = pd.read_csv(&quot;data/kinase_data_bind.csv&quot;)
tasks = [&quot;kinase_1_pIC50&quot;, &quot;kinase_2_pIC50&quot;]
smiles_column = &quot;smiles&quot;
ids_column = &quot;name_id&quot;

reg, tr, test, val, test_set_metrics_df = deep_net_models.train_multitask_regressor(
    data_df=data_df_bind,
    tasks=tasks,
    smiles_column=smiles_column,
    ids_column=ids_column,
    epochs=200,
    layer_sizes=[1000, 1000],
    )
</code></pre>
<p>Args:
    data_df (pd.DataFrame): the data frame containing the data
    tasks (List[str]): the names of the tasks to train on
    smiles_column (str): the name of the column containing the SMILES strings
    ids_column (Optional[str]): the name of the column containing the IDs
    task_weights (Optional[List[float]]): the weights for each task
    epochs (int): the number of epochs to train for
    learning_rate (float): the learning rate for the model
    layer_sizes (List[int]): the sizes of the layers in the model
    batch_size (int): the batch size for the model
    featurizer (Optional[dc.feat.Featurizer]): the featurizer to use
    splitter (Optional[dc.splits.Splitter]): the splitter to use
    unique_string (Optional[str]): a unique string to append to the output files
    pre_seed (bool): whether to pre seed the random number generators
    frac_train (float): the fraction of the data to use for training
    frac_valid (float): the fraction of the data to use for validation
    frac_test (float): the fraction of the data to use for testing
    uncertainty (bool): whether to use uncertainty in the model
    residual (bool): whether to use residual connections in the model
    weight_decay_penalty (float): the weight decay penalty to use
    weight_decay_penalty_type (str): the type of weight decay penalty to use
    dropouts (float | Sequence[float]): the dropouts to use
    activation_fns (Callable | str | Sequence[Callable | str]): the activation functions to use
    **kwargs: additional keyword arguments to pass to the model</p>
<p>Returns:
    tuple[Any, Any, Any, Any, pd.DataFrame]: the trained model, the training data set, the validation data set, the test data set, tests set metrics predictions</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-redxregressors.deep_net_models.train_multitask_regressor', this);">Show source &equiv;</a></p>
  <div id="source-redxregressors.deep_net_models.train_multitask_regressor" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">train_multitask_regressor</span><span class="p">(</span>
    <span class="n">tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">data_df</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">smiles_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;smiles&quot;</span><span class="p">,</span>
    <span class="n">ids_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">task_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">,</span>
    <span class="n">layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">featurizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">Featurizer</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">CircularFingerprint</span><span class="p">(</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">chiral</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bonds</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">),</span>
    <span class="n">splitter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">Splitter</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">RandomSplitter</span><span class="p">(),</span>
    <span class="n">unique_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">fit_transformers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">Transformer</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pre_seed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">frac_train</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">frac_valid</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">frac_test</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">uncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">residual</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">weight_decay_penalty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">weight_decay_penalty_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;l2&quot;</span><span class="p">,</span>
    <span class="n">dropouts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">activation_fns</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Callable</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">test_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">valid_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to train a multitask regressor using the deepchem library.</span>
<span class="sd">    Note the deepchem library is a wrapper around pytorch, Jax, tensorflow and keras.</span>

<span class="sd">    The examples online are unclear for the use of this model so this function is a wrapper to make it easier to use.</span>
<span class="sd">    The main difficulty is building the data set. By default the dispite naming the tasks when you define teh loader</span>
<span class="sd">    object it does not by defult pull these out as the tasks. In addition, the weights in the data set for each data</span>
<span class="sd">    point default to 0.0. Both of these mean that there are no target values for the model to train on.</span>
<span class="sd">    The symptom this is happening is a continous average loss of 0.0.</span>

<span class="sd">    It seem that one has to explicitly add these to the data set when running .create_dataset(). However again this is not clear</span>
<span class="sd">    as the fucntion signature does not have keys for these values. Instead it assumes an order of SMILES, targets, weights, ids</span>
<span class="sd">    passed as an iterable. This is implemented in this function to make it easier to use and abstract the details of the interfaces</span>
<span class="sd">    of the deepchem library.</span>

<span class="sd">    Example:</span>
<span class="sd">    ```python</span>
<span class="sd">    import logging</span>
<span class="sd">    from redxregressors import deep_net_models</span>

<span class="sd">    dc_logger = logging.getLogger(&quot;deepchem&quot;)</span>
<span class="sd">    dc_logger.setLevel(logging.WARNING)</span>

<span class="sd">    data_df_bind = pd.read_csv(&quot;data/kinase_data_bind.csv&quot;)</span>
<span class="sd">    tasks = [&quot;kinase_1_pIC50&quot;, &quot;kinase_2_pIC50&quot;]</span>
<span class="sd">    smiles_column = &quot;smiles&quot;</span>
<span class="sd">    ids_column = &quot;name_id&quot;</span>

<span class="sd">    reg, tr, test, val, test_set_metrics_df = deep_net_models.train_multitask_regressor(</span>
<span class="sd">        data_df=data_df_bind,</span>
<span class="sd">        tasks=tasks,</span>
<span class="sd">        smiles_column=smiles_column,</span>
<span class="sd">        ids_column=ids_column,</span>
<span class="sd">        epochs=200,</span>
<span class="sd">        layer_sizes=[1000, 1000],</span>
<span class="sd">        )</span>
<span class="sd">    ```</span>

<span class="sd">    Args:</span>
<span class="sd">        data_df (pd.DataFrame): the data frame containing the data</span>
<span class="sd">        tasks (List[str]): the names of the tasks to train on</span>
<span class="sd">        smiles_column (str): the name of the column containing the SMILES strings</span>
<span class="sd">        ids_column (Optional[str]): the name of the column containing the IDs</span>
<span class="sd">        task_weights (Optional[List[float]]): the weights for each task</span>
<span class="sd">        epochs (int): the number of epochs to train for</span>
<span class="sd">        learning_rate (float): the learning rate for the model</span>
<span class="sd">        layer_sizes (List[int]): the sizes of the layers in the model</span>
<span class="sd">        batch_size (int): the batch size for the model</span>
<span class="sd">        featurizer (Optional[dc.feat.Featurizer]): the featurizer to use</span>
<span class="sd">        splitter (Optional[dc.splits.Splitter]): the splitter to use</span>
<span class="sd">        unique_string (Optional[str]): a unique string to append to the output files</span>
<span class="sd">        pre_seed (bool): whether to pre seed the random number generators</span>
<span class="sd">        frac_train (float): the fraction of the data to use for training</span>
<span class="sd">        frac_valid (float): the fraction of the data to use for validation</span>
<span class="sd">        frac_test (float): the fraction of the data to use for testing</span>
<span class="sd">        uncertainty (bool): whether to use uncertainty in the model</span>
<span class="sd">        residual (bool): whether to use residual connections in the model</span>
<span class="sd">        weight_decay_penalty (float): the weight decay penalty to use</span>
<span class="sd">        weight_decay_penalty_type (str): the type of weight decay penalty to use</span>
<span class="sd">        dropouts (float | Sequence[float]): the dropouts to use</span>
<span class="sd">        activation_fns (Callable | str | Sequence[Callable | str]): the activation functions to use</span>
<span class="sd">        **kwargs: additional keyword arguments to pass to the model</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[Any, Any, Any, Any, pd.DataFrame]: the trained model, the training data set, the validation data set, the test data set, tests set metrics predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Pre seed the random number generators</span>
    <span class="k">if</span> <span class="n">pre_seed</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">seed_all</span><span class="p">()</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">use_deterministic_algorithms</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get all of the pieces that form the data set as rew data</span>
    <span class="k">if</span> <span class="n">train_dataset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">test_dataset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">valid_dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Building the data sets from pandas data frame input and column headers&quot;</span>
        <span class="p">)</span>
        <span class="n">smiles</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">smiles_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="n">ids_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">ids_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="n">task_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">tw</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">task_weights</span><span class="p">):</span>
                <span class="n">weights</span><span class="p">[:,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">*=</span> <span class="n">task_weights</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Only one task was provided, this is not a multitask model consider a different model type&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">tasks</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># get the data sets for training, validation and testing</span>
        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">splitter</span> <span class="o">=</span> <span class="n">build_in_memory_loader</span><span class="p">(</span>
            <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span>
            <span class="n">featurizer</span><span class="o">=</span><span class="n">featurizer</span><span class="p">,</span>
            <span class="n">ids_column</span><span class="o">=</span><span class="n">ids_column</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="n">smiles</span><span class="o">=</span><span class="n">smiles</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
            <span class="n">splitter</span><span class="o">=</span><span class="n">splitter</span><span class="p">,</span>
            <span class="n">frac_train</span><span class="o">=</span><span class="n">frac_train</span><span class="p">,</span>
            <span class="n">frac_valid</span><span class="o">=</span><span class="n">frac_valid</span><span class="p">,</span>
            <span class="n">frac_test</span><span class="o">=</span><span class="n">frac_test</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># if the data sets are provided then use them</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using the provided data sets&quot;</span><span class="p">)</span>
        <span class="n">splitter</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training dataset shape: </span><span class="si">{</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># instantiate the model</span>
    <span class="k">if</span> <span class="n">fit_transformers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">MultitaskRegressor</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">),</span>
            <span class="n">train_dataset</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">layer_sizes</span><span class="o">=</span><span class="n">layer_sizes</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
            <span class="n">weight_decay_penalty</span><span class="o">=</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
            <span class="n">weight_decay_penalty_type</span><span class="o">=</span><span class="n">weight_decay_penalty_type</span><span class="p">,</span>
            <span class="n">dropouts</span><span class="o">=</span><span class="n">dropouts</span><span class="p">,</span>
            <span class="n">activation_fns</span><span class="o">=</span><span class="n">activation_fns</span><span class="p">,</span>
            <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty</span><span class="p">,</span>
            <span class="n">residual</span><span class="o">=</span><span class="n">residual</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fit_transformers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ent</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">transform_X</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform_y</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">fit_transformers</span>
        <span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">MultitaskFitTransformRegressor</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">),</span>
            <span class="n">train_dataset</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">layer_sizes</span><span class="o">=</span><span class="n">layer_sizes</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
            <span class="n">weight_decay_penalty</span><span class="o">=</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
            <span class="n">weight_decay_penalty_type</span><span class="o">=</span><span class="n">weight_decay_penalty_type</span><span class="p">,</span>
            <span class="n">dropouts</span><span class="o">=</span><span class="n">dropouts</span><span class="p">,</span>
            <span class="n">activation_fns</span><span class="o">=</span><span class="n">activation_fns</span><span class="p">,</span>
            <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty</span><span class="p">,</span>
            <span class="n">residual</span><span class="o">=</span><span class="n">residual</span><span class="p">,</span>
            <span class="n">fit_transformers</span><span class="o">=</span><span class="n">fit_transformers</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># train the model using an explicit loop to allow for intermediate evaluation</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">fit_mtr_pytorch_model</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
        <span class="n">valid_dataset</span><span class="o">=</span><span class="n">valid_dataset</span><span class="p">,</span>
        <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
        <span class="n">unique_string</span><span class="o">=</span><span class="n">unique_string</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># evaluate the model using the test set</span>
    <span class="n">test_set_df</span> <span class="o">=</span> <span class="n">evaluate_mtr_pytorch_model</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">test_dataset</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span> <span class="n">unique_string</span><span class="o">=</span><span class="n">unique_string</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">test_set_df</span>
</pre></div>

  </div>
</div>

  </div>


  <div class="item">
    <div class="name def" id="redxregressors.deep_net_models.train_progressive_multitask_regressor">
    <p>def <span class="ident">train_progressive_multitask_regressor</span>(</p><p>data_df: pandas.core.frame.DataFrame, tasks: List[str], smiles_column: str = &#39;smiles&#39;, ids_column: Optional[str] = None, task_weights: Optional[List[float]] = None, epochs: int = 100, learning_rate: float = 0.0001, layer_sizes: List[int] = [1000, 1000], batch_size: int = 50, featurizer: Optional[deepchem.feat.base_classes.Featurizer] = CircularFingerprint[radius=2, size=1024, chiral=True, bonds=True, features=False, sparse=False, smiles=False, is_counts_based=False], splitter: Optional[deepchem.splits.splitters.Splitter] = RandomSplitter[], unique_string: Optional[str] = None, pre_seed: bool = True, frac_train: float = 0.8, frac_valid: float = 0.1, frac_test: float = 0.1, uncertainty: bool = False, residual: bool = False, weight_decay_penalty: float = 0.0, weight_decay_penalty_type: str = &#39;l2&#39;, dropouts: Union[float, Sequence[float]] = 0.5, activation_fns: Union[Callable, str, Sequence[Union[Callable, str]]] = &#39;relu&#39;, train_per_task: bool = False, **kwargs)</p>
    </div>




    <div class="desc"><p>Function to train a multitask regressor using the deepchem library.
Note the deepchem library is a wrapper around pytorch, Jax, tensorflow and keras.</p>
<p>The examples online are unclear for the use of this model so this function is a wrapper to make it easier to use.
The main difficulty is building the data set. By default the dispite naming the tasks when you define teh loader
object it does not by defult pull these out as the tasks. In addition, the weights in the data set for each data
point default to 0.0. Both of these mean that there are no target values for the model to train on.
The symptom this is happening is a continous average loss of 0.0.</p>
<p>It seem that one has to explicitly add these to the data set when running .create_dataset(). However again this is not clear
as the fucntion signature does not have keys for these values. Instead it assumes an order of SMILES, targets, weights, ids
passed as an iterable. This is implemented in this function to make it easier to use and abstract the details of the interfaces
of the deepchem library.</p>
<p>Example:</p>
<pre><code class="language-python">import logging
from redxregressors import deep_net_models

dc_logger = logging.getLogger(&quot;deepchem&quot;)
dc_logger.setLevel(logging.WARNING)

data_df_bind = pd.read_csv(&quot;data/kinase_data_bind.csv&quot;)
tasks = [&quot;kinase_1_pIC50&quot;, &quot;kinase_2_pIC50&quot;]
smiles_column = &quot;smiles&quot;
ids_column = &quot;name_id&quot;

reg, tr, test, val, test_set_metrics_df = deep_net_models.train_multitask_regressor(
    data_df=data_df_bind,
    tasks=tasks,
    smiles_column=smiles_column,
    ids_column=ids_column,
    epochs=200,
    layer_sizes=[1000, 1000],
    )
</code></pre>
<p>Args:
    data_df (pd.DataFrame): the data frame containing the data
    tasks (List[str]): the names of the tasks to train on
    smiles_column (str): the name of the column containing the SMILES strings
    ids_column (Optional[str]): the name of the column containing the IDs
    task_weights (Optional[List[float]]): the weights for each task
    epochs (int): the number of epochs to train for
    learning_rate (float): the learning rate for the model
    layer_sizes (List[int]): the sizes of the layers in the model
    batch_size (int): the batch size for the model
    featurizer (Optional[dc.feat.Featurizer]): the featurizer to use
    splitter (Optional[dc.splits.Splitter]): the splitter to use
    unique_string (Optional[str]): a unique string to append to the output files
    pre_seed (bool): whether to pre seed the random number generators
    frac_train (float): the fraction of the data to use for training
    frac_valid (float): the fraction of the data to use for validation
    frac_test (float): the fraction of the data to use for testing
    uncertainty (bool): whether to use uncertainty in the model
    residual (bool): whether to use residual connections in the model
    weight_decay_penalty (float): the weight decay penalty to use
    weight_decay_penalty_type (str): the type of weight decay penalty to use
    dropouts (float | Sequence[float]): the dropouts to use
    activation_fns (Callable | str | Sequence[Callable | str]): the activation functions to use
    train_per_task (bool): whether to train the model per task sequentially
    **kwargs: additional keyword arguments to pass to the model</p>
<p>Returns:
    tuple[Any, Any, Any, Any, pd.DataFrame]: the trained model, the training data set, the validation data set, the test data set, tests set metrics predictions</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-redxregressors.deep_net_models.train_progressive_multitask_regressor', this);">Show source &equiv;</a></p>
  <div id="source-redxregressors.deep_net_models.train_progressive_multitask_regressor" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">train_progressive_multitask_regressor</span><span class="p">(</span>
    <span class="n">data_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">smiles_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;smiles&quot;</span><span class="p">,</span>
    <span class="n">ids_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">task_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">,</span>
    <span class="n">layer_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">featurizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">Featurizer</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">feat</span><span class="o">.</span><span class="n">CircularFingerprint</span><span class="p">(</span>
        <span class="n">size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">chiral</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bonds</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">),</span>
    <span class="n">splitter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">Splitter</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">RandomSplitter</span><span class="p">(),</span>
    <span class="n">unique_string</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pre_seed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">frac_train</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">frac_valid</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">frac_test</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">uncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">residual</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">weight_decay_penalty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">weight_decay_penalty_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;l2&quot;</span><span class="p">,</span>
    <span class="n">dropouts</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">activation_fns</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Callable</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span>
    <span class="n">train_per_task</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to train a multitask regressor using the deepchem library.</span>
<span class="sd">    Note the deepchem library is a wrapper around pytorch, Jax, tensorflow and keras.</span>

<span class="sd">    The examples online are unclear for the use of this model so this function is a wrapper to make it easier to use.</span>
<span class="sd">    The main difficulty is building the data set. By default the dispite naming the tasks when you define teh loader</span>
<span class="sd">    object it does not by defult pull these out as the tasks. In addition, the weights in the data set for each data</span>
<span class="sd">    point default to 0.0. Both of these mean that there are no target values for the model to train on.</span>
<span class="sd">    The symptom this is happening is a continous average loss of 0.0.</span>

<span class="sd">    It seem that one has to explicitly add these to the data set when running .create_dataset(). However again this is not clear</span>
<span class="sd">    as the fucntion signature does not have keys for these values. Instead it assumes an order of SMILES, targets, weights, ids</span>
<span class="sd">    passed as an iterable. This is implemented in this function to make it easier to use and abstract the details of the interfaces</span>
<span class="sd">    of the deepchem library.</span>

<span class="sd">    Example:</span>
<span class="sd">    ```python</span>
<span class="sd">    import logging</span>
<span class="sd">    from redxregressors import deep_net_models</span>

<span class="sd">    dc_logger = logging.getLogger(&quot;deepchem&quot;)</span>
<span class="sd">    dc_logger.setLevel(logging.WARNING)</span>

<span class="sd">    data_df_bind = pd.read_csv(&quot;data/kinase_data_bind.csv&quot;)</span>
<span class="sd">    tasks = [&quot;kinase_1_pIC50&quot;, &quot;kinase_2_pIC50&quot;]</span>
<span class="sd">    smiles_column = &quot;smiles&quot;</span>
<span class="sd">    ids_column = &quot;name_id&quot;</span>

<span class="sd">    reg, tr, test, val, test_set_metrics_df = deep_net_models.train_multitask_regressor(</span>
<span class="sd">        data_df=data_df_bind,</span>
<span class="sd">        tasks=tasks,</span>
<span class="sd">        smiles_column=smiles_column,</span>
<span class="sd">        ids_column=ids_column,</span>
<span class="sd">        epochs=200,</span>
<span class="sd">        layer_sizes=[1000, 1000],</span>
<span class="sd">        )</span>
<span class="sd">    ```</span>

<span class="sd">    Args:</span>
<span class="sd">        data_df (pd.DataFrame): the data frame containing the data</span>
<span class="sd">        tasks (List[str]): the names of the tasks to train on</span>
<span class="sd">        smiles_column (str): the name of the column containing the SMILES strings</span>
<span class="sd">        ids_column (Optional[str]): the name of the column containing the IDs</span>
<span class="sd">        task_weights (Optional[List[float]]): the weights for each task</span>
<span class="sd">        epochs (int): the number of epochs to train for</span>
<span class="sd">        learning_rate (float): the learning rate for the model</span>
<span class="sd">        layer_sizes (List[int]): the sizes of the layers in the model</span>
<span class="sd">        batch_size (int): the batch size for the model</span>
<span class="sd">        featurizer (Optional[dc.feat.Featurizer]): the featurizer to use</span>
<span class="sd">        splitter (Optional[dc.splits.Splitter]): the splitter to use</span>
<span class="sd">        unique_string (Optional[str]): a unique string to append to the output files</span>
<span class="sd">        pre_seed (bool): whether to pre seed the random number generators</span>
<span class="sd">        frac_train (float): the fraction of the data to use for training</span>
<span class="sd">        frac_valid (float): the fraction of the data to use for validation</span>
<span class="sd">        frac_test (float): the fraction of the data to use for testing</span>
<span class="sd">        uncertainty (bool): whether to use uncertainty in the model</span>
<span class="sd">        residual (bool): whether to use residual connections in the model</span>
<span class="sd">        weight_decay_penalty (float): the weight decay penalty to use</span>
<span class="sd">        weight_decay_penalty_type (str): the type of weight decay penalty to use</span>
<span class="sd">        dropouts (float | Sequence[float]): the dropouts to use</span>
<span class="sd">        activation_fns (Callable | str | Sequence[Callable | str]): the activation functions to use</span>
<span class="sd">        train_per_task (bool): whether to train the model per task sequentially</span>
<span class="sd">        **kwargs: additional keyword arguments to pass to the model</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[Any, Any, Any, Any, pd.DataFrame]: the trained model, the training data set, the validation data set, the test data set, tests set metrics predictions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Pre seed the random number generators</span>
    <span class="k">if</span> <span class="n">pre_seed</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">seed_all</span><span class="p">()</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">use_deterministic_algorithms</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get all of the pieces that form the data set as rew data</span>
    <span class="n">smiles</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">smiles_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="n">ids_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">ids_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="n">task_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">tw</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">task_weights</span><span class="p">):</span>
            <span class="n">weights</span><span class="p">[:,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">*=</span> <span class="n">task_weights</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Only one task was provided, this is not a multitask model consider a different model type&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">tasks</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># get the data sets for training, validation and testing</span>
    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">splitter</span> <span class="o">=</span> <span class="n">build_in_memory_loader</span><span class="p">(</span>
        <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span>
        <span class="n">featurizer</span><span class="o">=</span><span class="n">featurizer</span><span class="p">,</span>
        <span class="n">ids_column</span><span class="o">=</span><span class="n">ids_column</span><span class="p">,</span>
        <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
        <span class="n">smiles</span><span class="o">=</span><span class="n">smiles</span><span class="p">,</span>
        <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
        <span class="n">splitter</span><span class="o">=</span><span class="n">splitter</span><span class="p">,</span>
        <span class="n">frac_train</span><span class="o">=</span><span class="n">frac_train</span><span class="p">,</span>
        <span class="n">frac_valid</span><span class="o">=</span><span class="n">frac_valid</span><span class="p">,</span>
        <span class="n">frac_test</span><span class="o">=</span><span class="n">frac_test</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training dataset shape: </span><span class="si">{</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># instantiate the model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">torch_models</span><span class="o">.</span><span class="n">ProgressiveMultitaskModel</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">),</span>
        <span class="n">train_dataset</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;regression&quot;</span><span class="p">,</span>
        <span class="n">layer_sizes</span><span class="o">=</span><span class="n">layer_sizes</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
        <span class="n">weight_decay_penalty</span><span class="o">=</span><span class="n">weight_decay_penalty</span><span class="p">,</span>
        <span class="n">weight_decay_penalty_type</span><span class="o">=</span><span class="n">weight_decay_penalty_type</span><span class="p">,</span>
        <span class="n">dropouts</span><span class="o">=</span><span class="n">dropouts</span><span class="p">,</span>
        <span class="n">activation_fns</span><span class="o">=</span><span class="n">activation_fns</span><span class="p">,</span>
        <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty</span><span class="p">,</span>
        <span class="n">residual</span><span class="o">=</span><span class="n">residual</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># train the model using an explicit loop to allow for intermediate evaluation</span>
    <span class="k">if</span> <span class="n">train_per_task</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">fit_mtr_pytorch_model</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">valid_dataset</span><span class="o">=</span><span class="n">valid_dataset</span><span class="p">,</span>
            <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
            <span class="n">unique_string</span><span class="o">=</span><span class="n">unique_string</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fit_mtr_pytorch_model_per_task</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">valid_dataset</span><span class="o">=</span><span class="n">valid_dataset</span><span class="p">,</span>
            <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
            <span class="n">unique_string</span><span class="o">=</span><span class="n">unique_string</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># evaluate the model using the test set</span>
    <span class="n">test_set_df</span> <span class="o">=</span> <span class="n">evaluate_mtr_pytorch_model</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">test_dataset</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span> <span class="n">unique_string</span><span class="o">=</span><span class="n">unique_string</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">valid_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">test_set_df</span>
</pre></div>

  </div>
</div>

  </div>



  </section>
</article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Generated by <a href="https://github.com/timothycrosley/pdocs">pdocs 1.2.0</a>
    </p>
  </footer>
</div>
</body>
</html>
