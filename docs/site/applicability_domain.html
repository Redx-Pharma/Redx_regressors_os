<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />


  <title>redxregressors.applicability_domain API documentation</title>
  <meta name="description" content="Module for calculating a models applicability domain. Please note there is no one way to calculate t..." />


  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>

  <style type="text/css">
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}
</style>
  <style type="text/css">
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  }

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; }

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;

      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/
</style>
  <style type="text/css">
  pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #ffffcc }
.codehilite { background: #f8f8f8; }
.codehilite .c { color: #3D7B7B; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #F00 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666 } /* Operator */
.codehilite .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #9C6500 } /* Comment.Preproc */
.codehilite .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.codehilite .gr { color: #E40000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #008400 } /* Generic.Inserted */
.codehilite .go { color: #717171 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #04D } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #687822 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #00F; font-weight: bold } /* Name.Class */
.codehilite .no { color: #800 } /* Name.Constant */
.codehilite .nd { color: #A2F } /* Name.Decorator */
.codehilite .ni { color: #717171; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #00F } /* Name.Function */
.codehilite .nl { color: #767600 } /* Name.Label */
.codehilite .nn { color: #00F; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #A2F; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #BBB } /* Text.Whitespace */
.codehilite .mb { color: #666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666 } /* Literal.Number.Float */
.codehilite .mh { color: #666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #A45A77 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #00F } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666 } /* Literal.Number.Integer.Long */
  </style>
  <style type="text/css">
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}
</style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>
<div id="container">




















  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">
    <li class="set"><h3>Super-module</h3>
      <ul>
        <li class="mono"><a href="index.html">redxregressors</a></li>
      </ul>
    </li>
    <li class="set"><h3><a href="#header-variables">Module variables</a></h3>

  <ul>
    <li class="mono"><a href="#redxregressors.applicability_domain.log">log</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>

  <ul>
    <li class="mono"><a href="#redxregressors.applicability_domain.calculate_distance_ad_from_model">calculate_distance_ad_from_model</a></li>
    <li class="mono"><a href="#redxregressors.applicability_domain.calculate_similarity_ad_from_model">calculate_similarity_ad_from_model</a></li>
    <li class="mono"><a href="#redxregressors.applicability_domain.get_ad_model">get_ad_model</a></li>
    <li class="mono"><a href="#redxregressors.applicability_domain.get_tanimoto_ad_model">get_tanimoto_ad_model</a></li>
    <li class="mono"><a href="#redxregressors.applicability_domain.tanimoto_ad">tanimoto_ad</a></li>
  </ul>

    </li>


    </ul>
  </div>

<article id="content">





  <header id="section-intro">
  <h1 class="title"><span class="name">redxregressors.applicability_domain</span> module</h1>
  <p>Module for calculating a models applicability domain. Please note there is no one way to calculate this and it is a choice how we define this.
The methods here are based on the Tanimoto similarity and the Jaccard distance of the ECFP fingerprints of the training set and the test set.
The domain is therefore defined as the set of molecules that are within a certain similarity threshold of the training set.</p>

  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-redxregressors.applicability_domain', this);">Show source &equiv;</a></p>
  <div id="source-redxregressors.applicability_domain" class="source">
    <div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for calculating a models applicability domain. Please note there is no one way to calculate this and it is a choice how we define this.</span>
<span class="sd">The methods here are based on the Tanimoto similarity and the Jaccard distance of the ECFP fingerprints of the training set and the test set.</span>
<span class="sd">The domain is therefore defined as the set of molecules that are within a certain similarity threshold of the training set.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Literal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArrayLike</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">AllChem</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataStructs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">NearestNeighbors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">redxregressors</span><span class="w"> </span><span class="kn">import</span> <span class="n">ml_featurization</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial.distance</span><span class="w"> </span><span class="kn">import</span> <span class="n">jaccard</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">tanimoto_ad</span><span class="p">(</span>
    <span class="n">training_smiles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">test_smiles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">tanimoto_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">hash_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="n">minimum_fraction_similar</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArrayLike</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate the applicability domain of a model using Tanimoto similarity</span>

<span class="sd">    Args:</span>
<span class="sd">        training_smiles (Iterable): An iterable of SMILES strings for the training set</span>
<span class="sd">        test_smiles (Iterable): An iterable of SMILES strings for the test set</span>
<span class="sd">        tanimoto_threshold (float): The threshold for the Tanimoto similarity</span>
<span class="sd">        radius (int): The radius for the Morgan fingerprint</span>
<span class="sd">        hash_length (int): The length of the hash for the fingerprint</span>

<span class="sd">    Returns:</span>
<span class="sd">        ArrayLike: A boolean array of whether the test set is within the threshold</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert SMILES to RDKit molecules</span>
    <span class="n">training_mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smile</span><span class="p">)</span> <span class="k">for</span> <span class="n">smile</span> <span class="ow">in</span> <span class="n">training_smiles</span><span class="p">]</span>
    <span class="n">test_mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smile</span><span class="p">)</span> <span class="k">for</span> <span class="n">smile</span> <span class="ow">in</span> <span class="n">test_smiles</span><span class="p">]</span>

    <span class="n">ecpf_generator</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetMorganGenerator</span><span class="p">(</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">fpSize</span><span class="o">=</span><span class="n">hash_length</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="c1"># Convert molecules to fingerprints</span>
    <span class="n">training_fps</span> <span class="o">=</span> <span class="n">ecpf_generator</span><span class="o">.</span><span class="n">GetFingerprints</span><span class="p">(</span><span class="n">training_mols</span><span class="p">,</span> <span class="n">numThreads</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">test_fps</span> <span class="o">=</span> <span class="n">ecpf_generator</span><span class="o">.</span><span class="n">GetFingerprints</span><span class="p">(</span><span class="n">test_mols</span><span class="p">,</span> <span class="n">numThreads</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Calculate bulk Tanimoto similarity</span>
    <span class="n">similarity_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">test_fps</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">training_fps</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">ith</span><span class="p">,</span> <span class="n">test_fp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_fps</span><span class="p">):</span>
        <span class="n">similarities</span> <span class="o">=</span> <span class="n">DataStructs</span><span class="o">.</span><span class="n">BulkTanimotoSimilarity</span><span class="p">(</span><span class="n">test_fp</span><span class="p">,</span> <span class="n">training_fps</span><span class="p">)</span>
        <span class="n">similarity_matrix</span><span class="p">[</span><span class="n">ith</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">similarities</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tanimoto similarity matrix: </span><span class="si">{</span><span class="n">similarity_matrix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Determine if each test molecule is within the threshold</span>
    <span class="k">if</span> <span class="n">minimum_fraction_similar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">within_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">similarity_matrix</span> <span class="o">&gt;=</span> <span class="n">tanimoto_threshold</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fraction_similar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">similarity_matrix</span> <span class="o">&gt;=</span> <span class="n">tanimoto_threshold</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">training_fps</span><span class="p">)</span>
        <span class="n">within_threshold</span> <span class="o">=</span> <span class="n">fraction_similar</span> <span class="o">&gt;=</span> <span class="n">minimum_fraction_similar</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In applicability domain Fraction similar: </span><span class="si">{</span><span class="n">fraction_similar</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In applicability domain within threshold: </span><span class="si">{</span><span class="n">within_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">within_threshold</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_tanimoto_ad_model</span><span class="p">(</span>
    <span class="n">training_smiles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">test_smiles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">hash_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="n">algorithm</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;ball_tree&quot;</span><span class="p">,</span> <span class="s2">&quot;kd_tree&quot;</span><span class="p">,</span> <span class="s2">&quot;brute&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;brute&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NearestNeighbors</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate the applicability domain of a model using Tanimoto/Jaccard distance</span>
<span class="sd">    Args:</span>
<span class="sd">        training_smiles (List[str]): the list of training smiles</span>
<span class="sd">        test_smiles (List[str]): the list of test smiles</span>
<span class="sd">        radius (int): the radius of the ECFP</span>
<span class="sd">        hash_length (int): the length of the hash for the ECFP</span>
<span class="sd">        algorithm (str): the algorithm to use for the NearestNeighbors</span>
<span class="sd">        **kwargs: the keyword arguments for the NearestNeighbors</span>

<span class="sd">    Returns:</span>
<span class="sd">        NearestNeighbors: the NearestNeighbors model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert SMILES to RDKit molecules</span>
    <span class="n">ecfp_reps</span> <span class="o">=</span> <span class="n">ml_featurization</span><span class="o">.</span><span class="n">get_ecfp</span><span class="p">(</span>
        <span class="n">smiles</span><span class="o">=</span><span class="n">training_smiles</span><span class="p">,</span> <span class="n">hash_length</span><span class="o">=</span><span class="n">hash_length</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># fit the model, note we use the brute force method by default this should be fine for small datasets and gives the extact answer</span>
    <span class="n">nn_model</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span>
        <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;jaccard&quot;</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ecfp_reps</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;boolean&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">test_smiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">test_ecfp_reps</span> <span class="o">=</span> <span class="n">ml_featurization</span><span class="o">.</span><span class="n">get_ecfp</span><span class="p">(</span>
            <span class="n">smiles</span><span class="o">=</span><span class="n">test_smiles</span><span class="p">,</span> <span class="n">hash_length</span><span class="o">=</span><span class="n">hash_length</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">model_distances</span><span class="p">,</span> <span class="n">model_closest_indexes</span> <span class="o">=</span> <span class="n">nn_model</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span>
            <span class="n">test_ecfp_reps</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;boolean&quot;</span><span class="p">),</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="n">closest_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">test_ecfp_reps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">closest_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">test_ecfp_reps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ith</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">test_ecfp</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_ecfp_reps</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">jth</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">train_ecfp</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ecfp_reps</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
                <span class="n">jaccard_dist</span> <span class="o">=</span> <span class="n">jaccard</span><span class="p">(</span>
                    <span class="n">test_ecfp</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
                    <span class="n">train_ecfp</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">jaccard_dist</span> <span class="o">&lt;</span> <span class="n">closest_distance</span><span class="p">[</span><span class="n">ith</span><span class="p">]:</span>
                    <span class="n">closest_distance</span><span class="p">[</span><span class="n">ith</span><span class="p">]</span> <span class="o">=</span> <span class="n">jaccard_dist</span>
                    <span class="n">closest_index</span><span class="p">[</span><span class="n">ith</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">jth</span><span class="p">)</span>

        <span class="n">dont_match</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ith</span><span class="p">,</span> <span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">ci</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">model_distances</span><span class="p">,</span> <span class="n">model_closest_indexes</span><span class="p">,</span> <span class="n">closest_distance</span><span class="p">,</span> <span class="n">closest_index</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model distances index </span><span class="si">{</span><span class="n">ith</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">md</span><span class="si">}</span><span class="s2"> Model indexes: </span><span class="si">{</span><span class="n">mi</span><span class="si">}</span><span class="s2"> Closest index: </span><span class="si">{</span><span class="n">ci</span><span class="si">}</span><span class="s2"> Closest distance: </span><span class="si">{</span><span class="n">cd</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-5</span> <span class="ow">or</span> <span class="n">mi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ci</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Model distances and closest index do not match the brute force method&quot;</span>
                <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Model distances index </span><span class="si">{</span><span class="n">ith</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> Model indexes: </span><span class="si">{</span><span class="n">mi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> Closest index: </span><span class="si">{</span><span class="n">ci</span><span class="si">}</span><span class="s2"> Closest distance: </span><span class="si">{</span><span class="n">cd</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="n">dont_match</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">dont_match</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Model distances and closest index from test set match the brute force and explicit methods&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># log.error(f&quot;model_distances: {model_distances} {model_distances.dtype} {os.linesep}model_closest_indexes: {model_closest_indexes} {model_closest_indexes.dtype} {os.linesep}closest_distance: {closest_distance} {closest_distance.dtype}{os.linesep}closest_index: {closest_index}{closest_index.dtype}&quot;)</span>
            <span class="n">err_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">[</span><span class="n">ent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">model_distances</span><span class="p">],</span>
                        <span class="p">[</span><span class="n">ent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">model_closest_indexes</span><span class="p">],</span>
                        <span class="n">closest_distance</span><span class="p">,</span>
                        <span class="n">closest_index</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                    <span class="s2">&quot;Model Dist&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Model Inx&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Exact Dist&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Exact Inx&quot;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}{</span><span class="n">err_df</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Model distances and closest index from test set do not match the brute force and explicit methods&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">nn_model</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_ad_model</span><span class="p">(</span>
    <span class="n">training_smiles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;jaccard&quot;</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">hash_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="n">algorithm</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;ball_tree&quot;</span><span class="p">,</span> <span class="s2">&quot;kd_tree&quot;</span><span class="p">,</span> <span class="s2">&quot;brute&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;brute&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NearestNeighbors</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate the applicability domain of a model using Tanimoto/Jaccard distance</span>
<span class="sd">    Args:</span>
<span class="sd">        training_smiles (Iterable): the list of training smiles</span>
<span class="sd">        metric (str): the distance metric to use for the NearestNeighbors</span>
<span class="sd">        radius (int): the radius of the ECFP</span>
<span class="sd">        hash_length (int): the length of the hash for the ECFP</span>
<span class="sd">        algorithm (str): the algorithm to use for the NearestNeighbors</span>
<span class="sd">        **kwargs: the keyword arguments for the NearestNeighbors</span>

<span class="sd">    Returns:</span>
<span class="sd">        NearestNeighbors: the NearestNeighbors model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert SMILES to RDKit molecules</span>
    <span class="n">ecfp_reps</span> <span class="o">=</span> <span class="n">ml_featurization</span><span class="o">.</span><span class="n">get_ecfp</span><span class="p">(</span>
        <span class="n">smiles</span><span class="o">=</span><span class="n">training_smiles</span><span class="p">,</span> <span class="n">hash_length</span><span class="o">=</span><span class="n">hash_length</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;jaccard&quot;</span><span class="p">:</span>
        <span class="n">ecfp_reps</span> <span class="o">=</span> <span class="n">ecfp_reps</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;boolean&quot;</span><span class="p">)</span>

    <span class="c1"># fit the model, note we use the brute force method by default this should be fine for small datasets and gives the extact answer</span>
    <span class="n">nn_model</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span>
        <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ecfp_reps</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nn_model</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calculate_similarity_ad_from_model</span><span class="p">(</span>
    <span class="n">nn_model</span><span class="p">:</span> <span class="n">NearestNeighbors</span><span class="p">,</span>
    <span class="n">test_smiles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">hash_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">n_neighbours_within_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to take a trained model and a test set and calculate the applicability domain</span>
<span class="sd">    Args:</span>
<span class="sd">        nn_model (NearestNeighbors): the fitted NearestNeighbors model</span>
<span class="sd">        test_smiles (List[str]): the list of test smiles</span>
<span class="sd">        radius (int): the radius of the ECFP</span>
<span class="sd">        hash_length (int): the length of the hash for the ECFP</span>
<span class="sd">        similarity_threshold (float): the similarity threshold this is the minimum similarity to be considered within the applicability domain</span>
<span class="sd">        n_neighbours_within_threshold (int): the number of neighbours within the threshold</span>
<span class="sd">        **kwargs: the keyword arguments for the NearestNeighbors</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[ArrayLike, ArrayLike]: a tuple of the boolean array of whether the test set is within the threshold and the indexes of the closest neighbours</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert tests set smiles to ECFP</span>
    <span class="n">test_ecfp_reps</span> <span class="o">=</span> <span class="n">ml_featurization</span><span class="o">.</span><span class="n">get_ecfp</span><span class="p">(</span>
        <span class="n">smiles</span><span class="o">=</span><span class="n">test_smiles</span><span class="p">,</span> <span class="n">hash_length</span><span class="o">=</span><span class="n">hash_length</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Calculate the nearest neighbours using the nerest neighbours model</span>
    <span class="n">model_distances</span><span class="p">,</span> <span class="n">model_closest_indexes</span> <span class="o">=</span> <span class="n">nn_model</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span>
        <span class="n">test_ecfp_reps</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbours_within_threshold</span>
    <span class="p">)</span>

    <span class="c1"># convert distances to similarity (similarity = 1.0 - distance)</span>
    <span class="n">similarity</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">model_distances</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Similarity: </span><span class="si">{</span><span class="n">similarity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># return boolean array of whether the test set is within the threshold</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Similarity threshold: </span><span class="si">{</span><span class="n">similarity_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_neighbours_within_threshold</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">within_threshold</span> <span class="o">=</span> <span class="n">similarity</span> <span class="o">&gt;=</span> <span class="n">similarity_threshold</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Within threshold: </span><span class="si">{</span><span class="n">within_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">within_threshold</span><span class="p">,</span> <span class="n">model_closest_indexes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">within_threshold</span> <span class="o">=</span> <span class="n">similarity</span> <span class="o">&gt;=</span> <span class="n">similarity_threshold</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Within threshold: </span><span class="si">{</span><span class="n">within_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">n_within_threshold</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">within_threshold</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n_neighbours_within_threshold</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_within_threshold: </span><span class="si">{</span><span class="n">n_within_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n_within_threshold</span><span class="p">,</span> <span class="n">model_closest_indexes</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calculate_distance_ad_from_model</span><span class="p">(</span>
    <span class="n">nn_model</span><span class="p">:</span> <span class="n">NearestNeighbors</span><span class="p">,</span>
    <span class="n">test_smiles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">hash_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="n">distance_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">n_neighbours_within_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to take a trained model and a test set and calculate the applicability domain</span>
<span class="sd">    Args:</span>
<span class="sd">        nn_model (NearestNeighbors): the fitted NearestNeighbors model</span>
<span class="sd">        test_smiles (List[str]): the list of test smiles</span>
<span class="sd">        radius (int): the radius of the ECFP</span>
<span class="sd">        hash_length (int): the length of the hash for the ECFP</span>
<span class="sd">        distance_threshold (float): the distance threshold for the NearestNeighbors model this is the maximum distance to be considered within ththe appicability domain</span>
<span class="sd">        n_neighbours_within_threshold (int): the number of neighbours within the threshold</span>
<span class="sd">        **kwargs: the keyword arguments for the NearestNeighbors</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[ArrayLike, ArrayLike]: a tuple of the boolean array of whether the test set is within the threshold and the indexes of the closest neighbours</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert tests set smiles to ECFP</span>
    <span class="n">test_ecfp_reps</span> <span class="o">=</span> <span class="n">ml_featurization</span><span class="o">.</span><span class="n">get_ecfp</span><span class="p">(</span>
        <span class="n">smiles</span><span class="o">=</span><span class="n">test_smiles</span><span class="p">,</span> <span class="n">hash_length</span><span class="o">=</span><span class="n">hash_length</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Calculate the nearest neighbours using the nerest neighbours model</span>
    <span class="n">model_distances</span><span class="p">,</span> <span class="n">model_closest_indexes</span> <span class="o">=</span> <span class="n">nn_model</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span>
        <span class="n">test_ecfp_reps</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbours_within_threshold</span>
    <span class="p">)</span>

    <span class="c1"># return boolean array of whether the test set is within the threshold</span>
    <span class="k">if</span> <span class="n">n_neighbours_within_threshold</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">within_threshold</span> <span class="o">=</span> <span class="n">model_distances</span> <span class="o">&lt;=</span> <span class="n">distance_threshold</span>
        <span class="k">return</span> <span class="n">within_threshold</span><span class="p">,</span> <span class="n">model_closest_indexes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">within_threshold</span> <span class="o">=</span> <span class="n">model_distances</span> <span class="o">&lt;=</span> <span class="n">distance_threshold</span>
        <span class="n">n_within_threshold</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">within_threshold</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n_neighbours_within_threshold</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">n_within_threshold</span><span class="p">,</span> <span class="n">model_closest_indexes</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">doctest</span>

    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">
    <h2 class="section-title" id="header-variables">Module variables</h2>
      <div class="item">
      <p id="redxregressors.applicability_domain.log" class="name">var <span class="ident">log</span></p>


  <div class="source_cont">
</div>

      </div>

    <h2 class="section-title" id="header-functions">Functions</h2>

  <div class="item">
    <div class="name def" id="redxregressors.applicability_domain.calculate_distance_ad_from_model">
    <p>def <span class="ident">calculate_distance_ad_from_model</span>(</p><p>nn_model: sklearn.neighbors._unsupervised.NearestNeighbors, test_smiles: List[str], radius: int = 2, hash_length: int = 1024, distance_threshold: float = 0.7, n_neighbours_within_threshold: int = 1, **kwargs)</p>
    </div>




    <div class="desc"><p>Function to take a trained model and a test set and calculate the applicability domain
Args:
    nn_model (NearestNeighbors): the fitted NearestNeighbors model
    test_smiles (List[str]): the list of test smiles
    radius (int): the radius of the ECFP
    hash_length (int): the length of the hash for the ECFP
    distance_threshold (float): the distance threshold for the NearestNeighbors model this is the maximum distance to be considered within ththe appicability domain
    n_neighbours_within_threshold (int): the number of neighbours within the threshold
    **kwargs: the keyword arguments for the NearestNeighbors</p>
<p>Returns:
    tuple[ArrayLike, ArrayLike]: a tuple of the boolean array of whether the test set is within the threshold and the indexes of the closest neighbours</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-redxregressors.applicability_domain.calculate_distance_ad_from_model', this);">Show source &equiv;</a></p>
  <div id="source-redxregressors.applicability_domain.calculate_distance_ad_from_model" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calculate_distance_ad_from_model</span><span class="p">(</span>
    <span class="n">nn_model</span><span class="p">:</span> <span class="n">NearestNeighbors</span><span class="p">,</span>
    <span class="n">test_smiles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">hash_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="n">distance_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">n_neighbours_within_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to take a trained model and a test set and calculate the applicability domain</span>
<span class="sd">    Args:</span>
<span class="sd">        nn_model (NearestNeighbors): the fitted NearestNeighbors model</span>
<span class="sd">        test_smiles (List[str]): the list of test smiles</span>
<span class="sd">        radius (int): the radius of the ECFP</span>
<span class="sd">        hash_length (int): the length of the hash for the ECFP</span>
<span class="sd">        distance_threshold (float): the distance threshold for the NearestNeighbors model this is the maximum distance to be considered within ththe appicability domain</span>
<span class="sd">        n_neighbours_within_threshold (int): the number of neighbours within the threshold</span>
<span class="sd">        **kwargs: the keyword arguments for the NearestNeighbors</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[ArrayLike, ArrayLike]: a tuple of the boolean array of whether the test set is within the threshold and the indexes of the closest neighbours</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert tests set smiles to ECFP</span>
    <span class="n">test_ecfp_reps</span> <span class="o">=</span> <span class="n">ml_featurization</span><span class="o">.</span><span class="n">get_ecfp</span><span class="p">(</span>
        <span class="n">smiles</span><span class="o">=</span><span class="n">test_smiles</span><span class="p">,</span> <span class="n">hash_length</span><span class="o">=</span><span class="n">hash_length</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Calculate the nearest neighbours using the nerest neighbours model</span>
    <span class="n">model_distances</span><span class="p">,</span> <span class="n">model_closest_indexes</span> <span class="o">=</span> <span class="n">nn_model</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span>
        <span class="n">test_ecfp_reps</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbours_within_threshold</span>
    <span class="p">)</span>

    <span class="c1"># return boolean array of whether the test set is within the threshold</span>
    <span class="k">if</span> <span class="n">n_neighbours_within_threshold</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">within_threshold</span> <span class="o">=</span> <span class="n">model_distances</span> <span class="o">&lt;=</span> <span class="n">distance_threshold</span>
        <span class="k">return</span> <span class="n">within_threshold</span><span class="p">,</span> <span class="n">model_closest_indexes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">within_threshold</span> <span class="o">=</span> <span class="n">model_distances</span> <span class="o">&lt;=</span> <span class="n">distance_threshold</span>
        <span class="n">n_within_threshold</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">within_threshold</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n_neighbours_within_threshold</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">n_within_threshold</span><span class="p">,</span> <span class="n">model_closest_indexes</span>
</pre></div>

  </div>
</div>

  </div>


  <div class="item">
    <div class="name def" id="redxregressors.applicability_domain.calculate_similarity_ad_from_model">
    <p>def <span class="ident">calculate_similarity_ad_from_model</span>(</p><p>nn_model: sklearn.neighbors._unsupervised.NearestNeighbors, test_smiles: List[str], radius: int = 2, hash_length: int = 1024, similarity_threshold: float = 0.7, n_neighbours_within_threshold: int = 1, **kwargs)</p>
    </div>




    <div class="desc"><p>Function to take a trained model and a test set and calculate the applicability domain
Args:
    nn_model (NearestNeighbors): the fitted NearestNeighbors model
    test_smiles (List[str]): the list of test smiles
    radius (int): the radius of the ECFP
    hash_length (int): the length of the hash for the ECFP
    similarity_threshold (float): the similarity threshold this is the minimum similarity to be considered within the applicability domain
    n_neighbours_within_threshold (int): the number of neighbours within the threshold
    **kwargs: the keyword arguments for the NearestNeighbors</p>
<p>Returns:
    tuple[ArrayLike, ArrayLike]: a tuple of the boolean array of whether the test set is within the threshold and the indexes of the closest neighbours</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-redxregressors.applicability_domain.calculate_similarity_ad_from_model', this);">Show source &equiv;</a></p>
  <div id="source-redxregressors.applicability_domain.calculate_similarity_ad_from_model" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calculate_similarity_ad_from_model</span><span class="p">(</span>
    <span class="n">nn_model</span><span class="p">:</span> <span class="n">NearestNeighbors</span><span class="p">,</span>
    <span class="n">test_smiles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">hash_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">n_neighbours_within_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to take a trained model and a test set and calculate the applicability domain</span>
<span class="sd">    Args:</span>
<span class="sd">        nn_model (NearestNeighbors): the fitted NearestNeighbors model</span>
<span class="sd">        test_smiles (List[str]): the list of test smiles</span>
<span class="sd">        radius (int): the radius of the ECFP</span>
<span class="sd">        hash_length (int): the length of the hash for the ECFP</span>
<span class="sd">        similarity_threshold (float): the similarity threshold this is the minimum similarity to be considered within the applicability domain</span>
<span class="sd">        n_neighbours_within_threshold (int): the number of neighbours within the threshold</span>
<span class="sd">        **kwargs: the keyword arguments for the NearestNeighbors</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[ArrayLike, ArrayLike]: a tuple of the boolean array of whether the test set is within the threshold and the indexes of the closest neighbours</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert tests set smiles to ECFP</span>
    <span class="n">test_ecfp_reps</span> <span class="o">=</span> <span class="n">ml_featurization</span><span class="o">.</span><span class="n">get_ecfp</span><span class="p">(</span>
        <span class="n">smiles</span><span class="o">=</span><span class="n">test_smiles</span><span class="p">,</span> <span class="n">hash_length</span><span class="o">=</span><span class="n">hash_length</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Calculate the nearest neighbours using the nerest neighbours model</span>
    <span class="n">model_distances</span><span class="p">,</span> <span class="n">model_closest_indexes</span> <span class="o">=</span> <span class="n">nn_model</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span>
        <span class="n">test_ecfp_reps</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbours_within_threshold</span>
    <span class="p">)</span>

    <span class="c1"># convert distances to similarity (similarity = 1.0 - distance)</span>
    <span class="n">similarity</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">model_distances</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Similarity: </span><span class="si">{</span><span class="n">similarity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># return boolean array of whether the test set is within the threshold</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Similarity threshold: </span><span class="si">{</span><span class="n">similarity_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_neighbours_within_threshold</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">within_threshold</span> <span class="o">=</span> <span class="n">similarity</span> <span class="o">&gt;=</span> <span class="n">similarity_threshold</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Within threshold: </span><span class="si">{</span><span class="n">within_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">within_threshold</span><span class="p">,</span> <span class="n">model_closest_indexes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">within_threshold</span> <span class="o">=</span> <span class="n">similarity</span> <span class="o">&gt;=</span> <span class="n">similarity_threshold</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Within threshold: </span><span class="si">{</span><span class="n">within_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">n_within_threshold</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">within_threshold</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n_neighbours_within_threshold</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_within_threshold: </span><span class="si">{</span><span class="n">n_within_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n_within_threshold</span><span class="p">,</span> <span class="n">model_closest_indexes</span>
</pre></div>

  </div>
</div>

  </div>


  <div class="item">
    <div class="name def" id="redxregressors.applicability_domain.get_ad_model">
    <p>def <span class="ident">get_ad_model</span>(</p><p>training_smiles: List[str], metric: str = &#39;jaccard&#39;, radius: int = 2, hash_length: int = 1024, algorithm: Literal[&#39;auto&#39;, &#39;ball_tree&#39;, &#39;kd_tree&#39;, &#39;brute&#39;] = &#39;brute&#39;, **kwargs)</p>
    </div>




    <div class="desc"><p>Function to calculate the applicability domain of a model using Tanimoto/Jaccard distance
Args:
    training_smiles (Iterable): the list of training smiles
    metric (str): the distance metric to use for the NearestNeighbors
    radius (int): the radius of the ECFP
    hash_length (int): the length of the hash for the ECFP
    algorithm (str): the algorithm to use for the NearestNeighbors
    **kwargs: the keyword arguments for the NearestNeighbors</p>
<p>Returns:
    NearestNeighbors: the NearestNeighbors model</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-redxregressors.applicability_domain.get_ad_model', this);">Show source &equiv;</a></p>
  <div id="source-redxregressors.applicability_domain.get_ad_model" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_ad_model</span><span class="p">(</span>
    <span class="n">training_smiles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;jaccard&quot;</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">hash_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="n">algorithm</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;ball_tree&quot;</span><span class="p">,</span> <span class="s2">&quot;kd_tree&quot;</span><span class="p">,</span> <span class="s2">&quot;brute&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;brute&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NearestNeighbors</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate the applicability domain of a model using Tanimoto/Jaccard distance</span>
<span class="sd">    Args:</span>
<span class="sd">        training_smiles (Iterable): the list of training smiles</span>
<span class="sd">        metric (str): the distance metric to use for the NearestNeighbors</span>
<span class="sd">        radius (int): the radius of the ECFP</span>
<span class="sd">        hash_length (int): the length of the hash for the ECFP</span>
<span class="sd">        algorithm (str): the algorithm to use for the NearestNeighbors</span>
<span class="sd">        **kwargs: the keyword arguments for the NearestNeighbors</span>

<span class="sd">    Returns:</span>
<span class="sd">        NearestNeighbors: the NearestNeighbors model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert SMILES to RDKit molecules</span>
    <span class="n">ecfp_reps</span> <span class="o">=</span> <span class="n">ml_featurization</span><span class="o">.</span><span class="n">get_ecfp</span><span class="p">(</span>
        <span class="n">smiles</span><span class="o">=</span><span class="n">training_smiles</span><span class="p">,</span> <span class="n">hash_length</span><span class="o">=</span><span class="n">hash_length</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;jaccard&quot;</span><span class="p">:</span>
        <span class="n">ecfp_reps</span> <span class="o">=</span> <span class="n">ecfp_reps</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;boolean&quot;</span><span class="p">)</span>

    <span class="c1"># fit the model, note we use the brute force method by default this should be fine for small datasets and gives the extact answer</span>
    <span class="n">nn_model</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span>
        <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ecfp_reps</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nn_model</span>
</pre></div>

  </div>
</div>

  </div>


  <div class="item">
    <div class="name def" id="redxregressors.applicability_domain.get_tanimoto_ad_model">
    <p>def <span class="ident">get_tanimoto_ad_model</span>(</p><p>training_smiles: List[str], test_smiles: Optional[List[str]] = None, radius: int = 2, hash_length: int = 1024, algorithm: Literal[&#39;auto&#39;, &#39;ball_tree&#39;, &#39;kd_tree&#39;, &#39;brute&#39;] = &#39;brute&#39;, **kwargs)</p>
    </div>




    <div class="desc"><p>Function to calculate the applicability domain of a model using Tanimoto/Jaccard distance
Args:
    training_smiles (List[str]): the list of training smiles
    test_smiles (List[str]): the list of test smiles
    radius (int): the radius of the ECFP
    hash_length (int): the length of the hash for the ECFP
    algorithm (str): the algorithm to use for the NearestNeighbors
    **kwargs: the keyword arguments for the NearestNeighbors</p>
<p>Returns:
    NearestNeighbors: the NearestNeighbors model</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-redxregressors.applicability_domain.get_tanimoto_ad_model', this);">Show source &equiv;</a></p>
  <div id="source-redxregressors.applicability_domain.get_tanimoto_ad_model" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_tanimoto_ad_model</span><span class="p">(</span>
    <span class="n">training_smiles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">test_smiles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">hash_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="n">algorithm</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;ball_tree&quot;</span><span class="p">,</span> <span class="s2">&quot;kd_tree&quot;</span><span class="p">,</span> <span class="s2">&quot;brute&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;brute&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NearestNeighbors</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate the applicability domain of a model using Tanimoto/Jaccard distance</span>
<span class="sd">    Args:</span>
<span class="sd">        training_smiles (List[str]): the list of training smiles</span>
<span class="sd">        test_smiles (List[str]): the list of test smiles</span>
<span class="sd">        radius (int): the radius of the ECFP</span>
<span class="sd">        hash_length (int): the length of the hash for the ECFP</span>
<span class="sd">        algorithm (str): the algorithm to use for the NearestNeighbors</span>
<span class="sd">        **kwargs: the keyword arguments for the NearestNeighbors</span>

<span class="sd">    Returns:</span>
<span class="sd">        NearestNeighbors: the NearestNeighbors model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert SMILES to RDKit molecules</span>
    <span class="n">ecfp_reps</span> <span class="o">=</span> <span class="n">ml_featurization</span><span class="o">.</span><span class="n">get_ecfp</span><span class="p">(</span>
        <span class="n">smiles</span><span class="o">=</span><span class="n">training_smiles</span><span class="p">,</span> <span class="n">hash_length</span><span class="o">=</span><span class="n">hash_length</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># fit the model, note we use the brute force method by default this should be fine for small datasets and gives the extact answer</span>
    <span class="n">nn_model</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span>
        <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;jaccard&quot;</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ecfp_reps</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;boolean&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">test_smiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">test_ecfp_reps</span> <span class="o">=</span> <span class="n">ml_featurization</span><span class="o">.</span><span class="n">get_ecfp</span><span class="p">(</span>
            <span class="n">smiles</span><span class="o">=</span><span class="n">test_smiles</span><span class="p">,</span> <span class="n">hash_length</span><span class="o">=</span><span class="n">hash_length</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">model_distances</span><span class="p">,</span> <span class="n">model_closest_indexes</span> <span class="o">=</span> <span class="n">nn_model</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span>
            <span class="n">test_ecfp_reps</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;boolean&quot;</span><span class="p">),</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="n">closest_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">test_ecfp_reps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">closest_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">test_ecfp_reps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ith</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">test_ecfp</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_ecfp_reps</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">jth</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">train_ecfp</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ecfp_reps</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
                <span class="n">jaccard_dist</span> <span class="o">=</span> <span class="n">jaccard</span><span class="p">(</span>
                    <span class="n">test_ecfp</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
                    <span class="n">train_ecfp</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">jaccard_dist</span> <span class="o">&lt;</span> <span class="n">closest_distance</span><span class="p">[</span><span class="n">ith</span><span class="p">]:</span>
                    <span class="n">closest_distance</span><span class="p">[</span><span class="n">ith</span><span class="p">]</span> <span class="o">=</span> <span class="n">jaccard_dist</span>
                    <span class="n">closest_index</span><span class="p">[</span><span class="n">ith</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">jth</span><span class="p">)</span>

        <span class="n">dont_match</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ith</span><span class="p">,</span> <span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">ci</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">model_distances</span><span class="p">,</span> <span class="n">model_closest_indexes</span><span class="p">,</span> <span class="n">closest_distance</span><span class="p">,</span> <span class="n">closest_index</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model distances index </span><span class="si">{</span><span class="n">ith</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">md</span><span class="si">}</span><span class="s2"> Model indexes: </span><span class="si">{</span><span class="n">mi</span><span class="si">}</span><span class="s2"> Closest index: </span><span class="si">{</span><span class="n">ci</span><span class="si">}</span><span class="s2"> Closest distance: </span><span class="si">{</span><span class="n">cd</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-5</span> <span class="ow">or</span> <span class="n">mi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ci</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Model distances and closest index do not match the brute force method&quot;</span>
                <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Model distances index </span><span class="si">{</span><span class="n">ith</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">md</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> Model indexes: </span><span class="si">{</span><span class="n">mi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> Closest index: </span><span class="si">{</span><span class="n">ci</span><span class="si">}</span><span class="s2"> Closest distance: </span><span class="si">{</span><span class="n">cd</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="n">dont_match</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">dont_match</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Model distances and closest index from test set match the brute force and explicit methods&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># log.error(f&quot;model_distances: {model_distances} {model_distances.dtype} {os.linesep}model_closest_indexes: {model_closest_indexes} {model_closest_indexes.dtype} {os.linesep}closest_distance: {closest_distance} {closest_distance.dtype}{os.linesep}closest_index: {closest_index}{closest_index.dtype}&quot;)</span>
            <span class="n">err_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">[</span><span class="n">ent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">model_distances</span><span class="p">],</span>
                        <span class="p">[</span><span class="n">ent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">model_closest_indexes</span><span class="p">],</span>
                        <span class="n">closest_distance</span><span class="p">,</span>
                        <span class="n">closest_index</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                    <span class="s2">&quot;Model Dist&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Model Inx&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Exact Dist&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Exact Inx&quot;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}{</span><span class="n">err_df</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Model distances and closest index from test set do not match the brute force and explicit methods&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">nn_model</span>
</pre></div>

  </div>
</div>

  </div>


  <div class="item">
    <div class="name def" id="redxregressors.applicability_domain.tanimoto_ad">
    <p>def <span class="ident">tanimoto_ad</span>(</p><p>training_smiles: List[str], test_smiles: List[str], tanimoto_threshold: float = 0.7, radius: int = 2, hash_length: int = 1024, minimum_fraction_similar: Optional[float] = None, **kwargs)</p>
    </div>




    <div class="desc"><p>Function to calculate the applicability domain of a model using Tanimoto similarity</p>
<p>Args:
    training_smiles (Iterable): An iterable of SMILES strings for the training set
    test_smiles (Iterable): An iterable of SMILES strings for the test set
    tanimoto_threshold (float): The threshold for the Tanimoto similarity
    radius (int): The radius for the Morgan fingerprint
    hash_length (int): The length of the hash for the fingerprint</p>
<p>Returns:
    ArrayLike: A boolean array of whether the test set is within the threshold</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-redxregressors.applicability_domain.tanimoto_ad', this);">Show source &equiv;</a></p>
  <div id="source-redxregressors.applicability_domain.tanimoto_ad" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">tanimoto_ad</span><span class="p">(</span>
    <span class="n">training_smiles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">test_smiles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">tanimoto_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">hash_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="n">minimum_fraction_similar</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArrayLike</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate the applicability domain of a model using Tanimoto similarity</span>

<span class="sd">    Args:</span>
<span class="sd">        training_smiles (Iterable): An iterable of SMILES strings for the training set</span>
<span class="sd">        test_smiles (Iterable): An iterable of SMILES strings for the test set</span>
<span class="sd">        tanimoto_threshold (float): The threshold for the Tanimoto similarity</span>
<span class="sd">        radius (int): The radius for the Morgan fingerprint</span>
<span class="sd">        hash_length (int): The length of the hash for the fingerprint</span>

<span class="sd">    Returns:</span>
<span class="sd">        ArrayLike: A boolean array of whether the test set is within the threshold</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert SMILES to RDKit molecules</span>
    <span class="n">training_mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smile</span><span class="p">)</span> <span class="k">for</span> <span class="n">smile</span> <span class="ow">in</span> <span class="n">training_smiles</span><span class="p">]</span>
    <span class="n">test_mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smile</span><span class="p">)</span> <span class="k">for</span> <span class="n">smile</span> <span class="ow">in</span> <span class="n">test_smiles</span><span class="p">]</span>

    <span class="n">ecpf_generator</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">GetMorganGenerator</span><span class="p">(</span>
        <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">fpSize</span><span class="o">=</span><span class="n">hash_length</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="c1"># Convert molecules to fingerprints</span>
    <span class="n">training_fps</span> <span class="o">=</span> <span class="n">ecpf_generator</span><span class="o">.</span><span class="n">GetFingerprints</span><span class="p">(</span><span class="n">training_mols</span><span class="p">,</span> <span class="n">numThreads</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">test_fps</span> <span class="o">=</span> <span class="n">ecpf_generator</span><span class="o">.</span><span class="n">GetFingerprints</span><span class="p">(</span><span class="n">test_mols</span><span class="p">,</span> <span class="n">numThreads</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Calculate bulk Tanimoto similarity</span>
    <span class="n">similarity_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">test_fps</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">training_fps</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">ith</span><span class="p">,</span> <span class="n">test_fp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_fps</span><span class="p">):</span>
        <span class="n">similarities</span> <span class="o">=</span> <span class="n">DataStructs</span><span class="o">.</span><span class="n">BulkTanimotoSimilarity</span><span class="p">(</span><span class="n">test_fp</span><span class="p">,</span> <span class="n">training_fps</span><span class="p">)</span>
        <span class="n">similarity_matrix</span><span class="p">[</span><span class="n">ith</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">similarities</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tanimoto similarity matrix: </span><span class="si">{</span><span class="n">similarity_matrix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Determine if each test molecule is within the threshold</span>
    <span class="k">if</span> <span class="n">minimum_fraction_similar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">within_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">similarity_matrix</span> <span class="o">&gt;=</span> <span class="n">tanimoto_threshold</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fraction_similar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">similarity_matrix</span> <span class="o">&gt;=</span> <span class="n">tanimoto_threshold</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">training_fps</span><span class="p">)</span>
        <span class="n">within_threshold</span> <span class="o">=</span> <span class="n">fraction_similar</span> <span class="o">&gt;=</span> <span class="n">minimum_fraction_similar</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In applicability domain Fraction similar: </span><span class="si">{</span><span class="n">fraction_similar</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In applicability domain within threshold: </span><span class="si">{</span><span class="n">within_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">within_threshold</span>
</pre></div>

  </div>
</div>

  </div>



  </section>
</article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Generated by <a href="https://github.com/timothycrosley/pdocs">pdocs 1.2.0</a>
    </p>
  </footer>
</div>
</body>
</html>
